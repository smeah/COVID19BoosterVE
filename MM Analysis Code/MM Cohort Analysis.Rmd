---
title: "MM Cohort Analysis"
author: "Sabir Meah"
date: "2023-06-18"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(survival)
library(survminer)
library(MatchIt)
library(broom)
```

# Data Read-In

Data read-in code is omitted as it comprises almost entirely of simply the specific file paths for data files (loaded from .Rsav files using the `load()` function). Unfortunately, the data files cannot be shared publicly because of patient confidentiality.  

# Data Manipulation

```{r}
# Making more managable trimmed dataset
CombinedCohorts_Trimmed <- CombinedCohorts %>%
  select(Encrypted_PatientID, DaysSinceBirth_First_PositiveTestDiagnosis, Deceased_DaysSinceBirth, DaysSinceBirth_FirstVaccinated, DaysSinceBirth_FullyVaccinated, DaysSinceBirth_FirstBooster, DaysSinceBirth_SecondBooster, RaceEthnicity4, Adult, Age, AgeCategory, BMI, BMI_class, BMI_category, Sex, disadvantage2_13_17_qrtl, popden13_17_qrtl, DaysSinceBirth_First_Hospital_Admission, DaysSinceBirth_First_ICU_Admission, Relative_First_Hospital_Stay, Relative_First_ICU_Stay, Relative_Death, `COVID-19 positive`, LastDaySinceBirth, FirstVaccinatedWith, FirstBooster, TotalNumberVaccinations, PrimaryCareMM_YN, UncertainDiagnosisData, negativeTests, VaccineSeriesTime)
```

```{r}
# Set the fully vaccinated/boosted buffer to 14 days (can change later)
CombinedCohorts_Trimmed$DaysSinceBirth_FullyVaccinated_14 <- CombinedCohorts_Trimmed$DaysSinceBirth_FullyVaccinated - 21 + 14
CombinedCohorts_Trimmed$DaysSinceBirth_FullyBoosted_14 <- CombinedCohorts_Trimmed$DaysSinceBirth_FirstBooster + 14
CombinedCohorts_Trimmed$DaysSinceBirth_SecondBoosted_14 <- CombinedCohorts_Trimmed$DaysSinceBirth_SecondBooster + 14
```

```{r}
# Restricting to mRNA primary dose and booster
CombinedCohorts_Trimmed <- CombinedCohorts_Trimmed %>%
  filter(FirstVaccinatedWith %in% c("Moderna", "Pfizer") & FirstBooster %in% c("Moderna", "Pfizer"))
```

```{r}
# Removing all unvaccinated
CombinedCohorts_Trimmed <- CombinedCohorts_Trimmed %>%
  filter(TotalNumberVaccinations >= 1 & FirstVaccinatedWith == "Janssen" | TotalNumberVaccinations >= 2 & FirstVaccinatedWith %in% c("Moderna", "Pfizer"))
```

```{r}
# Vaccination and Booster Max Index Dates
# Based on Dec 11, 2020 EUA and Q4 2021 Booster Start
# Based on Q2 2022 Booster 2 Start
# Currently using 1/1/23 pull date
FV_MaxTime <- 751
Booster_MaxTime <- 457
Booster2_MaxTime <- 275
```

```{r}
# Adjustment from Sept 1, 2022 magic numbers to new pull date
# Currently set using 1/1/23 pull date
DayAdj <- 122
```


## Merging With VaxData

```{r}
# Convert hexdecimal patient IDs to decimal
CombinedCohorts_Trimmed$Encrypted_PatientID <- as.numeric(CombinedCohorts_Trimmed$Encrypted_PatientID)
```

```{r}
VaxData <- VaxData %>%
  left_join(select(CombinedCohorts_Trimmed, c("Encrypted_PatientID", "FirstVaccinatedWith")), by = "Encrypted_PatientID") %>%
  filter(Vaccine %in% c("Janssen", "Moderna", "Pfizer")) %>%
  mutate(Difference23 = ifelse(VaccinationNumber == 2 & FirstVaccinatedWith == "Janssen" | VaccinationNumber == 3 & FirstVaccinatedWith %in% c("Moderna", "Pfizer"),
                                yes = Difference,
                                no = NA)) %>%
  mutate(Difference34 = ifelse(VaccinationNumber == 3 & FirstVaccinatedWith == "Janssen" | VaccinationNumber == 4 & FirstVaccinatedWith %in% c("Moderna", "Pfizer"),
                                yes = Difference,
                                no = NA)) %>%
  mutate(FullVaccination = ifelse(VaccinationNumber == 1 & FirstVaccinatedWith == "Janssen" | VaccinationNumber == 2 & FirstVaccinatedWith %in% c("Moderna", "Pfizer"),
                                yes = 1,
                                no = 0)) %>%
  mutate(Booster = ifelse(VaccinationNumber == 2 & FirstVaccinatedWith == "Janssen" | VaccinationNumber == 3 & FirstVaccinatedWith %in% c("Moderna", "Pfizer"),
                                yes = 1,
                                no = 0)) %>%
  mutate(Booster2 = ifelse(VaccinationNumber == 3 & FirstVaccinatedWith == "Janssen" | VaccinationNumber == 4 & FirstVaccinatedWith %in% c("Moderna", "Pfizer"),
                                yes = 1,
                                no = 0))
```

```{r}
# Variable for days between uniform draw of day from quarter of full vaccination and data pull date
# Currently set for September 1, 2022 (not including that day)
set.seed(6523)
DaysFVtoPull <- case_when(
  VaxData$FullVaccination == 1 & VaxData$YEAR_IMMUNE_DATE == 2020 & VaxData$QUARTER_IMMUNE_DATE == 4 ~ rdunif(n = nrow(VaxData), a = 609 + DayAdj, b = 700 + DayAdj),
  VaxData$FullVaccination == 1 & VaxData$YEAR_IMMUNE_DATE == 2021 & VaxData$QUARTER_IMMUNE_DATE == 1 ~ rdunif(n = nrow(VaxData), a = 519 + DayAdj, b = 608 + DayAdj),
  VaxData$FullVaccination == 1 & VaxData$YEAR_IMMUNE_DATE == 2021 & VaxData$QUARTER_IMMUNE_DATE == 2 ~ rdunif(n = nrow(VaxData), a = 428 + DayAdj, b = 518 + DayAdj),
  VaxData$FullVaccination == 1 & VaxData$YEAR_IMMUNE_DATE == 2021 & VaxData$QUARTER_IMMUNE_DATE == 3 ~ rdunif(n = nrow(VaxData), a = 336 + DayAdj, b = 427 + DayAdj),
  VaxData$FullVaccination == 1 & VaxData$YEAR_IMMUNE_DATE == 2021 & VaxData$QUARTER_IMMUNE_DATE == 4 ~ rdunif(n = nrow(VaxData), a = 224 + DayAdj, b = 335 + DayAdj),
  VaxData$FullVaccination == 1 & VaxData$YEAR_IMMUNE_DATE == 2022 & VaxData$QUARTER_IMMUNE_DATE == 1 ~ rdunif(n = nrow(VaxData), a = 154 + DayAdj, b = 223 + DayAdj),
  VaxData$FullVaccination == 1 & VaxData$YEAR_IMMUNE_DATE == 2022 & VaxData$QUARTER_IMMUNE_DATE == 2 ~ rdunif(n = nrow(VaxData), a = 63 + DayAdj, b = 153 + DayAdj),
  VaxData$FullVaccination == 1 & VaxData$YEAR_IMMUNE_DATE == 2022 & VaxData$QUARTER_IMMUNE_DATE == 3 ~ rdunif(n = nrow(VaxData), a = 93, b = 62 + DayAdj),
  VaxData$FullVaccination == 1 & VaxData$YEAR_IMMUNE_DATE == 2022 & VaxData$QUARTER_IMMUNE_DATE == 4 ~ rdunif(n = nrow(VaxData), a = 0, b = 92),
  TRUE ~ NA_real_
)
```

```{r}
# Variable for days between uniform draw of day from quarter of first booster and data pull date
# Currently set for September 1, 2022 (not including that day)
set.seed(65543)
DaysBoostertoPull <- case_when(
  VaxData$Booster == 1 & VaxData$YEAR_IMMUNE_DATE == 2021 & VaxData$QUARTER_IMMUNE_DATE == 4 ~ rdunif(n = nrow(VaxData), a = 224 + DayAdj, b = 335 + DayAdj),
  VaxData$Booster == 1 & VaxData$YEAR_IMMUNE_DATE == 2022 & VaxData$QUARTER_IMMUNE_DATE == 1 ~ rdunif(n = nrow(VaxData), a = 154 + DayAdj, b = 223 + DayAdj),
  VaxData$Booster == 1 & VaxData$YEAR_IMMUNE_DATE == 2022 & VaxData$QUARTER_IMMUNE_DATE == 2 ~ rdunif(n = nrow(VaxData), a = 63 + DayAdj, b = 153 + DayAdj),
  VaxData$Booster == 1 & VaxData$YEAR_IMMUNE_DATE == 2022 & VaxData$QUARTER_IMMUNE_DATE == 3 ~ rdunif(n = nrow(VaxData), a = 93, b = 62 + DayAdj),
  VaxData$Booster == 1 & VaxData$YEAR_IMMUNE_DATE == 2022 & VaxData$QUARTER_IMMUNE_DATE == 4 ~ rdunif(n = nrow(VaxData), a = 0, b = 92),
  TRUE ~ NA_real_
)
```

```{r}
# Variable for result and quarter of vaccination
YearQuarter_Immune <- case_when(
  VaxData$YEAR_IMMUNE_DATE == 2020 & VaxData$QUARTER_IMMUNE_DATE == 4 ~ 1,
  VaxData$YEAR_IMMUNE_DATE == 2021 & VaxData$QUARTER_IMMUNE_DATE == 1 ~ 2,
  VaxData$YEAR_IMMUNE_DATE == 2021 & VaxData$QUARTER_IMMUNE_DATE == 2 ~ 3,
  VaxData$YEAR_IMMUNE_DATE == 2021 & VaxData$QUARTER_IMMUNE_DATE == 3 ~ 4,
  VaxData$YEAR_IMMUNE_DATE == 2021 & VaxData$QUARTER_IMMUNE_DATE == 4 ~ 5,
  VaxData$YEAR_IMMUNE_DATE == 2022 & VaxData$QUARTER_IMMUNE_DATE == 1 ~ 6,
  VaxData$YEAR_IMMUNE_DATE == 2022 & VaxData$QUARTER_IMMUNE_DATE == 2 ~ 7,
  VaxData$YEAR_IMMUNE_DATE == 2022 & VaxData$QUARTER_IMMUNE_DATE == 3 ~ 8,
  VaxData$YEAR_IMMUNE_DATE == 2022 & VaxData$QUARTER_IMMUNE_DATE == 4 ~ 9,
  TRUE ~ 0
)
```


```{r}
# Adding above variables to VaxData dataset
VaxData <- VaxData %>%
  mutate(DaysFVtoPull) %>%
  mutate(DaysBoostertoPull) %>%
  mutate(YearQuarter_Immune) %>%
  mutate(YearQuarter_FV = ifelse(FullVaccination == 1, yes = YearQuarter_Immune, no = NA)) %>%
  mutate(YearQuarter_Booster = ifelse(Booster == 1, yes = YearQuarter_Immune, no = NA)) %>%
  mutate(YearQuarter_Booster2 = ifelse(Booster2 == 1, yes = YearQuarter_Immune, no = NA))
```


```{r}
# Adding these to combined cohorts dataset
CombinedCohorts_Trimmed <- CombinedCohorts_Trimmed %>%
  left_join(filter(select(VaxData, c("Encrypted_PatientID", "DaysFVtoPull")), !is.na(DaysFVtoPull)), 
            by = "Encrypted_PatientID") %>%
  left_join(filter(select(VaxData, c("Encrypted_PatientID", "DaysBoostertoPull")), !is.na(DaysBoostertoPull)), 
            by = "Encrypted_PatientID") %>%
  left_join(filter(select(VaxData, c("Encrypted_PatientID", "YearQuarter_FV")), !is.na(YearQuarter_FV)), 
          by = "Encrypted_PatientID") %>%
  left_join(filter(select(VaxData, c("Encrypted_PatientID", "YearQuarter_Booster")), !is.na(YearQuarter_Booster)), 
          by = "Encrypted_PatientID") %>%
  left_join(filter(select(VaxData, c("Encrypted_PatientID", "YearQuarter_Booster2")), !is.na(YearQuarter_Booster2)), 
          by = "Encrypted_PatientID")
```

## Merging With Other DFs

```{r}
# Merge with Charlson score data
CharlsonScoreCombined$Encrypted_PatientID <- as.numeric(CharlsonScoreCombined$Encrypted_PatientID)
CombinedCohorts_Trimmed <- CombinedCohorts_Trimmed %>%
  left_join(select(CharlsonScoreCombined, c("Encrypted_PatientID", "score", "index")), 
            by = "Encrypted_PatientID")
```

```{r}
# Add healthcare worker status variable (merge with HCW data)
HCW_IDs <- as.numeric(as.matrix(read.table("FILE PATH OMITTED")))
CombinedCohorts_Trimmed <- CombinedCohorts_Trimmed %>%
  mutate(HCW = as.factor(ifelse(Encrypted_PatientID %in% HCW_IDs, yes = 1, no = 0)))
```

```{r}
# Add oral antivirals
CombinedCohorts_Trimmed <- CombinedCohorts_Trimmed %>%
  left_join(select(OralAntivirals, c("Encrypted_PatientID", "OralAntivirals_DaysSinceBirth")),
            by = "Encrypted_PatientID") %>%
  mutate(Relative_First_OralAntivirals = OralAntivirals_DaysSinceBirth - DaysSinceBirth_First_PositiveTestDiagnosis)
```

```{r}
# Add monoclonal antibodies
CombinedCohorts_Trimmed <- CombinedCohorts_Trimmed %>%
  left_join(select(MonoclonalAntibodies, c("Encrypted_PatientID", "mAB_DaysSinceBirth")),
            by = "Encrypted_PatientID") %>%
  mutate(Relative_First_mAB = mAB_DaysSinceBirth - DaysSinceBirth_First_PositiveTestDiagnosis)
```


## Survival Time Calc

```{r}
CombinedCohorts_Trimmed <- CombinedCohorts_Trimmed %>%
  mutate(DaysFVtoLastEHR = LastDaySinceBirth - DaysSinceBirth_FirstVaccinated)
```

```{r}
# Removing negative values
CombinedCohorts_Trimmed[CombinedCohorts_Trimmed$DaysFVtoLastEHR < 0,]$DaysFVtoLastEHR <- NA

# Removing values that would suggest a vaccination before first EUA date, if last entry was the day before pull date
CombinedCohorts_Trimmed[CombinedCohorts_Trimmed$DaysFVtoLastEHR > FV_MaxTime,]$DaysFVtoLastEHR <- NA
```

```{r}
CombinedCohorts_Trimmed <- CombinedCohorts_Trimmed %>%
  mutate(DaysBoostertoLastEHR = LastDaySinceBirth - DaysSinceBirth_FirstBooster)
```

```{r}
# Removing negative values
CombinedCohorts_Trimmed[CombinedCohorts_Trimmed$DaysBoostertoLastEHR < 0,]$DaysBoostertoLastEHR <- NA

# Removing values that would suggest a booster before first EUA date, if last entry was the day before pull date
CombinedCohorts_Trimmed[CombinedCohorts_Trimmed$DaysBoostertoLastEHR > Booster_MaxTime,]$DaysBoostertoLastEHR <- NA
```

```{r}
CombinedCohorts_Trimmed <- CombinedCohorts_Trimmed %>%
  mutate(DaysBooster2toLastEHR = LastDaySinceBirth - DaysSinceBirth_SecondBooster)
```

```{r}
# Removing negative values
CombinedCohorts_Trimmed[CombinedCohorts_Trimmed$DaysBooster2toLastEHR < 0,]$DaysBooster2toLastEHR <- NA

# Removing values that would suggest a booster before first EUA date, if last entry was the day before pull date
CombinedCohorts_Trimmed[CombinedCohorts_Trimmed$DaysBooster2toLastEHR > Booster2_MaxTime,]$DaysBooster2toLastEHR <- NA
```

```{r}
# Adding days since birth for third booster
VaccineSeriesTime_Unsplit <- strsplit(CombinedCohorts_Trimmed$VaccineSeriesTime, ",")
#DaysSinceBirth_ThirdBoosted <- case_when(VaccineSeriesTime_Unsplit)
DaysSinceBirth_ThirdBoosted <- rep(NA_real_, length(VaccineSeriesTime_Unsplit))
for(i in 1:length(VaccineSeriesTime_Unsplit)){
  DaysSinceBirth_ThirdBoosted[i] <- as.numeric(VaccineSeriesTime_Unsplit[[i]][5])
}

DaysSinceBirth_ThirdBoosted[DaysSinceBirth_ThirdBoosted < 0] <- NA

CombinedCohorts_Trimmed <- CombinedCohorts_Trimmed %>%
  mutate(DaysSinceBirth_ThirdBoosted = as.numeric(DaysSinceBirth_ThirdBoosted)) %>%
  mutate(DaysSinceBirth_ThirdBoosted_14 = DaysSinceBirth_ThirdBoosted + 14)
```

```{r}
CombinedCohorts_Trimmed <- CombinedCohorts_Trimmed %>%
  mutate(DaysBooster3toLastEHR = LastDaySinceBirth - DaysSinceBirth_ThirdBoosted)
```

```{r}
# Removing negative values
CombinedCohorts_Trimmed[CombinedCohorts_Trimmed$DaysBooster3toLastEHR < 0,]$DaysBooster3toLastEHR <- NA

# Removing values that would suggest a booster before second booster EUA date, if last entry was the day before pull date
CombinedCohorts_Trimmed[CombinedCohorts_Trimmed$DaysBooster3toLastEHR > Booster2_MaxTime,]$DaysBooster3toLastEHR <- NA
```

### Indicators

#### Positive Before Vax

```{r}
# Positive before fully vaccinated indicator
CombinedCohorts_Trimmed <- CombinedCohorts_Trimmed %>%
  mutate(Positive_Before_FullyVaccinated = ifelse(DaysSinceBirth_FullyVaccinated_14 - DaysSinceBirth_First_PositiveTestDiagnosis > 0 | (is.na(DaysSinceBirth_FullyVaccinated) & !is.na(DaysSinceBirth_First_PositiveTestDiagnosis)),
                                                   yes = 1, 
                                                   no = 0))
```

```{r}
# Positive before boosted indicator
CombinedCohorts_Trimmed <- CombinedCohorts_Trimmed %>%
  mutate(Positive_Before_Boosted = ifelse(DaysSinceBirth_FullyBoosted_14 - DaysSinceBirth_First_PositiveTestDiagnosis > 0  | (is.na(DaysSinceBirth_FirstBooster) & !is.na(DaysSinceBirth_First_PositiveTestDiagnosis)),
                                                   yes = 1, 
                                                   no = 0))
```

```{r}
# Positive before 2nd boosted indicator
CombinedCohorts_Trimmed <- CombinedCohorts_Trimmed %>%
  mutate(Positive_Before_SecondBoosted = ifelse(DaysSinceBirth_SecondBoosted_14 - DaysSinceBirth_First_PositiveTestDiagnosis > 0 | (is.na(DaysSinceBirth_SecondBooster) & !is.na(DaysSinceBirth_First_PositiveTestDiagnosis)),
                                                   yes = 1, 
                                                   no = 0))
```

```{r}
# Positive before 3rd boosted indicator
CombinedCohorts_Trimmed <- CombinedCohorts_Trimmed %>%
  mutate(Positive_Before_ThirdBoosted = ifelse(DaysSinceBirth_ThirdBoosted_14 - DaysSinceBirth_First_PositiveTestDiagnosis > 0 | (is.na(DaysSinceBirth_ThirdBoosted) & !is.na(DaysSinceBirth_First_PositiveTestDiagnosis)),
                                                   yes = 1, 
                                                   no = 0))
```

#### Contributed Time

```{r}
# Indicator for if contributed time as fully vaccinated
# CHECK IF THIS IS CORRECT
CombinedCohorts_Trimmed <- CombinedCohorts_Trimmed %>%
  mutate(FVTime_Ind = ifelse((Positive_Before_FullyVaccinated == 0 | is.na(Positive_Before_FullyVaccinated)) & !is.na(DaysSinceBirth_FullyVaccinated),
                             yes = 1,
                             no = 0))
```

```{r}
# Filtering data so only those who contributed time as fully vaccinated are included
CombinedCohorts_Trimmed <- CombinedCohorts_Trimmed %>%
  filter(FVTime_Ind == 1)
```


```{r}
# Indicator for if contributed time as boosted
CombinedCohorts_Trimmed <- CombinedCohorts_Trimmed %>%
  mutate(BoostTime_Ind = ifelse((Positive_Before_Boosted == 0 | is.na(Positive_Before_Boosted)) & !is.na(DaysSinceBirth_FirstBooster),
                             yes = 1,
                             no = 0))
```

```{r}
# Indicator for if contributed time as 2 boosted
CombinedCohorts_Trimmed <- CombinedCohorts_Trimmed %>%
  mutate(Boost2Time_Ind = ifelse((Positive_Before_Boosted == 0 | is.na(Positive_Before_Boosted)) & (Positive_Before_SecondBoosted == 0 | is.na(Positive_Before_SecondBoosted)) & !is.na(DaysSinceBirth_SecondBoosted_14),
                             yes = 1,
                             no = 0))
```

```{r}
# Indicator for if contributed time as 3 boosted
CombinedCohorts_Trimmed <- CombinedCohorts_Trimmed %>%
  mutate(Boost3Time_Ind = ifelse((Positive_Before_Boosted == 0 | is.na(Positive_Before_Boosted)) & (Positive_Before_SecondBoosted == 0 | is.na(Positive_Before_SecondBoosted)) & (Positive_Before_ThirdBoosted == 0 | is.na(Positive_Before_ThirdBoosted)) & !is.na(DaysSinceBirth_ThirdBoosted_14),
                             yes = 1,
                             no = 0))
```

#### Infection

```{r}
# Indicator for if had infection as full vaccinated
CombinedCohorts_Trimmed <- CombinedCohorts_Trimmed %>%
#  mutate(PosDuringFV = ifelse(FVTime_Ind == 1 & (isTRUE(Positive_Before_Boosted == 1) | (!is.na(DaysSinceBirth_First_PositiveTestDiagnosis) & is.na(DaysSinceBirth_FirstBooster))), 
  mutate(PosDuringFV = ifelse(FVTime_Ind == 1 & Positive_Before_Boosted == 1,
                              yes = 1,
                              no = 0))
CombinedCohorts_Trimmed$PosDuringFV[is.na(CombinedCohorts_Trimmed$PosDuringFV)] <- 0
CombinedCohorts_Trimmed$PosDuringFV[CombinedCohorts_Trimmed$FVTime_Ind == 0] <- NA
```

```{r}
# Indicator for if had infection as boosted
CombinedCohorts_Trimmed <- CombinedCohorts_Trimmed %>%
  mutate(PosDuringBoost = ifelse(BoostTime_Ind == 1 & Positive_Before_SecondBoosted == 1, 
                              yes = 1,
                              no = 0))
CombinedCohorts_Trimmed$PosDuringBoost[is.na(CombinedCohorts_Trimmed$PosDuringBoost)] <- 0
CombinedCohorts_Trimmed$PosDuringBoost[CombinedCohorts_Trimmed$BoostTime_Ind == 0] <- NA
```

```{r}
# Indicator for if had infection as 2 boosted
CombinedCohorts_Trimmed <- CombinedCohorts_Trimmed %>%
  mutate(PosDuringBoost2 = ifelse(Boost2Time_Ind == 1 & Positive_Before_ThirdBoosted == 1, 
                              yes = 1,
                              no = 0))
CombinedCohorts_Trimmed$PosDuringBoost2[is.na(CombinedCohorts_Trimmed$PosDuringBoost2)] <- 0
CombinedCohorts_Trimmed$PosDuringBoost2[CombinedCohorts_Trimmed$Boost2Time_Ind == 0] <- NA
```

```{r}
# Indicator for if had infection as 3 boosted or later
# Note the defintion (not super consistent with naming)
CombinedCohorts_Trimmed <- CombinedCohorts_Trimmed %>%
  mutate(PosDuringBoost3 = ifelse(Boost3Time_Ind == 1 & Positive_Before_ThirdBoosted == 0, 
                              yes = 1,
                              no = 0))
CombinedCohorts_Trimmed$PosDuringBoost3[is.na(CombinedCohorts_Trimmed$Boost3Time_Ind)] <- 0
CombinedCohorts_Trimmed$PosDuringBoost3[CombinedCohorts_Trimmed$Boost3Time_Ind == 0] <- NA
```


#### Hospitalization

```{r}
# Indicator for
# First hospital admission within -7 to 30 days of first test diagnosis
CombinedCohorts_Trimmed <- CombinedCohorts_Trimmed %>%
  mutate(COVID_Hospitalized = ifelse(Relative_First_Hospital_Stay %in% -7:30,
                                     yes = 1,
                                     no = 0))
```

```{r}
# Indicator for hospitalization when fully vaccinated
# Need to get a better definition?
CombinedCohorts_Trimmed <- CombinedCohorts_Trimmed %>%
  mutate(HosDuringFV = ifelse(COVID_Hospitalized == 1 & PosDuringFV == 1,
                              yes = 1,
                              no = 0))
#CombinedCohorts_Trimmed$HosDuringFV[CombinedCohorts_Trimmed$FVTime_Ind == 0] <- NA
```

```{r}
# Indicator for hospitalization when boosted
# Need to get a better definition?
CombinedCohorts_Trimmed <- CombinedCohorts_Trimmed %>%
  mutate(HosDuringBoost = ifelse(COVID_Hospitalized == 1 & PosDuringBoost == 1,
                              yes = 1,
                              no = 0))
#CombinedCohorts_Trimmed$HosDuringBoost[CombinedCohorts_Trimmed$BoostTime_Ind == 0] <- NA
```

```{r}
# Indicator for hospitalization when 2 boosted
CombinedCohorts_Trimmed <- CombinedCohorts_Trimmed %>%
  mutate(HosDuringBoost2 = ifelse(COVID_Hospitalized == 1 & PosDuringBoost2 == 1,
                                  yes = 1,
                                  no = 0))
```

#### ICU

```{r}
# Indicator for
# First ICU admission within -7 to 30 days of first test diagnosis
CombinedCohorts_Trimmed <- CombinedCohorts_Trimmed %>%
  mutate(COVID_ICU = ifelse(Relative_First_ICU_Stay %in% -7:30,
                                     yes = 1,
                                     no = 0))
```

#### Death

```{r}
# Indicator for death within 60 days of first test diagnosis
CombinedCohorts_Trimmed <- CombinedCohorts_Trimmed %>%
  mutate(COVID_Death = ifelse(Relative_Death %in% 0:60,
                                     yes = 1,
                                     no = 0))
```

```{r}
# Indicator for death when fully vaccinated
CombinedCohorts_Trimmed <- CombinedCohorts_Trimmed %>%
  mutate(DeathDuringFV = ifelse(COVID_Death == 1 & PosDuringFV == 1,
                              yes = 1,
                              no = 0))
```

```{r}
# Indicator for death when boosted
CombinedCohorts_Trimmed <- CombinedCohorts_Trimmed %>%
  mutate(DeathDuringBoost = ifelse(COVID_Death == 1 & PosDuringBoost == 1,
                              yes = 1,
                              no = 0))
```

```{r}
# Indicator for death when 2 boosted
CombinedCohorts_Trimmed <- CombinedCohorts_Trimmed %>%
  mutate(DeathDuringBoost2 = ifelse(COVID_Death == 1 & PosDuringBoost2 == 1,
                              yes = 1,
                              no = 0))
```

#### Severe Disease

```{r}
# Indicator for severe disease (hospitalization, ICU, or death)
CombinedCohorts_Trimmed <- CombinedCohorts_Trimmed %>%
  mutate(COVID_Severe = ifelse(Relative_First_Hospital_Stay %in% -7:30 | Relative_First_ICU_Stay %in% -7:30 | Relative_Death %in% 0:60,
                               yes = 1,
                               no = 0))
```

```{r}
# Indicator for severe disease when fully vaccinated
CombinedCohorts_Trimmed <- CombinedCohorts_Trimmed %>%
  mutate(SevereDuringFV = ifelse(COVID_Severe == 1 & PosDuringFV == 1,
                              yes = 1,
                              no = 0))
```

```{r}
# Indicator for severe disease when boosted
CombinedCohorts_Trimmed <- CombinedCohorts_Trimmed %>%
  mutate(SevereDuringBoost = ifelse(COVID_Severe == 1 & PosDuringBoost == 1,
                              yes = 1,
                              no = 0))
```

```{r}
# Indicator for severe disease when 2 boosted
CombinedCohorts_Trimmed <- CombinedCohorts_Trimmed %>%
  mutate(SevereDuringBoost2 = ifelse(COVID_Severe == 1 & PosDuringBoost2 == 1,
                              yes = 1,
                              no = 0))
```


### Survival Time

```{r}
# Infection survival time
# Uncomment ### for based on conditional end of study censoring

# Third and later boosters survival time
# Booster3_SurvivalTime_Infection <- case_when(
###  CombinedCohorts_Trimmed$Boost3Time_Ind == 1 & CombinedCohorts_Trimmed$PosDuringBoost3 == 0 & CombinedCohorts_Trimmed$DaysBooster3toLastEHR == 0 ~ CombinedCohorts_Trimmed$DaysBooster3toPull,
#  CombinedCohorts_Trimmed$Boost3Time_Ind == 1 & CombinedCohorts_Trimmed$PosDuringBoost3 == 0 & CombinedCohorts_Trimmed$DaysBooster3toLastEHR > 0 ~ as.numeric(CombinedCohorts_Trimmed$DaysBoostertoLastEHR),
#  CombinedCohorts_Trimmed$Boost3Time_Ind == 1 & CombinedCohorts_Trimmed$PosDuringBoost3 == 1 ~ CombinedCohorts_Trimmed$DaysSinceBirth_First_PositiveTestDiagnosis - CombinedCohorts_Trimmed$DaysSinceBirth_ThirdBoosted_14,
#  TRUE ~ NA_real_
#)

# (Only) Second booster infection survival time
#Booster2_SurvivalTime_Infection <- case_when(
###  CombinedCohorts_Trimmed$Boost2Time_Ind == 1 & CombinedCohorts_Trimmed$Boost3Time_Ind == 0 & CombinedCohorts_Trimmed$PosDuringBoost2 == 0 & CombinedCohorts_Trimmed$DaysBooster2toLastEHR == 0 ~ CombinedCohorts_Trimmed$DaysBooster2toPull,
###  CombinedCohorts_Trimmed$Boost2Time_Ind == 1 & CombinedCohorts_Trimmed$Boost3Time_Ind == 1 & CombinedCohorts_Trimmed$PosDuringBoost2 == 0 & CombinedCohorts_Trimmed$DaysBooster2toLastEHR == 0 ~ CombinedCohorts_Trimmed$DaysBooster2toPull - Booster3_SurvivalTime_Infection,
#  CombinedCohorts_Trimmed$Boost2Time_Ind == 1 & CombinedCohorts_Trimmed$Boost3Time_Ind == 0 & CombinedCohorts_Trimmed$PosDuringBoost2 == 0 & CombinedCohorts_Trimmed$DaysBooster2toLastEHR > 0 ~ as.numeric(CombinedCohorts_Trimmed$DaysBooster2toLastEHR),
#  CombinedCohorts_Trimmed$Boost2Time_Ind == 1 & CombinedCohorts_Trimmed$Boost3Time_Ind == 1 & CombinedCohorts_Trimmed$PosDuringBoost2 == 0 & CombinedCohorts_Trimmed$DaysBooster2toLastEHR > 0 ~ as.numeric(CombinedCohorts_Trimmed$DaysBooster2toLastEHR) - Booster3_SurvivalTime_Infection,
#  CombinedCohorts_Trimmed$Boost2Time_Ind == 1 & CombinedCohorts_Trimmed$Boost3Time_Ind == 0 & CombinedCohorts_Trimmed$PosDuringBoost2 == 1 ~ CombinedCohorts_Trimmed$DaysSinceBirth_First_PositiveTestDiagnosis - CombinedCohorts_Trimmed$DaysSinceBirth_SecondBoosted_14,
#  TRUE ~ NA_real_
#)

# Second and later boosters survival time
#Booster2_SurvivalTime_Infection <- case_when(
###  CombinedCohorts_Trimmed$Boost2Time_Ind == 1 & CombinedCohorts_Trimmed$PosDuringBoost2 == 0 & CombinedCohorts_Trimmed$DaysBooster2toLastEHR == 0 ~ CombinedCohorts_Trimmed$DaysBooster2toPull,
#  CombinedCohorts_Trimmed$Boost2Time_Ind == 1 & CombinedCohorts_Trimmed$PosDuringBoost2 == 0 & CombinedCohorts_Trimmed$DaysBooster2toLastEHR > 0 ~ as.numeric(CombinedCohorts_Trimmed$DaysBoostertoLastEHR),
#  CombinedCohorts_Trimmed$Boost2Time_Ind == 1 & CombinedCohorts_Trimmed$PosDuringBoost2 == 1 ~ CombinedCohorts_Trimmed$DaysSinceBirth_First_PositiveTestDiagnosis - CombinedCohorts_Trimmed$DaysSinceBirth_SecondBoosted_14,
#  TRUE ~ NA_real_
#)

# First booster and later infection survival time

Booster_SurvivalTime_Infection <- case_when(
###  CombinedCohorts_Trimmed$BoostTime_Ind == 1 & CombinedCohorts_Trimmed$PosDuringBoost == 0 & CombinedCohorts_Trimmed$DaysBoostertoLastEHR == 0 ~ CombinedCohorts_Trimmed$DaysBoostertoPull,
  CombinedCohorts_Trimmed$BoostTime_Ind == 1 & CombinedCohorts_Trimmed$PosDuringBoost == 0 & CombinedCohorts_Trimmed$DaysBoostertoLastEHR > 0 ~ as.numeric(CombinedCohorts_Trimmed$DaysBoostertoLastEHR),
  CombinedCohorts_Trimmed$BoostTime_Ind == 1 & CombinedCohorts_Trimmed$PosDuringBoost == 1 ~ CombinedCohorts_Trimmed$DaysSinceBirth_First_PositiveTestDiagnosis - CombinedCohorts_Trimmed$DaysSinceBirth_FullyBoosted_14,
  TRUE ~ NA_real_
)

# First Booster Only Survival Time
#Booster_SurvivalTime_Infection <- case_when(
###  CombinedCohorts_Trimmed$BoostTime_Ind == 1 & CombinedCohorts_Trimmed$Boost2Time_Ind == 0 & CombinedCohorts_Trimmed$PosDuringBoost == 0 & CombinedCohorts_Trimmed$DaysBoostertoLastEHR == 0 ~ CombinedCohorts_Trimmed$DaysBoostertoPull,
###  CombinedCohorts_Trimmed$BoostTime_Ind == 1 & CombinedCohorts_Trimmed$Boost2Time_Ind == 1 & CombinedCohorts_Trimmed$PosDuringBoost == 0 & CombinedCohorts_Trimmed$DaysBoostertoLastEHR == 0 ~ CombinedCohorts_Trimmed$DaysBoostertoPull - Booster2_SurvivalTime_Infection,
#  CombinedCohorts_Trimmed$BoostTime_Ind == 1 & CombinedCohorts_Trimmed$Boost2Time_Ind == 0 & CombinedCohorts_Trimmed$PosDuringBoost == 0 & CombinedCohorts_Trimmed$DaysBoostertoLastEHR > 0 ~ as.numeric(CombinedCohorts_Trimmed$DaysBoostertoLastEHR),
#  CombinedCohorts_Trimmed$BoostTime_Ind == 1 & CombinedCohorts_Trimmed$Boost2Time_Ind == 1 & CombinedCohorts_Trimmed$PosDuringBoost == 0 & CombinedCohorts_Trimmed$DaysBoostertoLastEHR > 0 ~ as.numeric(CombinedCohorts_Trimmed$DaysBoostertoLastEHR) - Booster2_SurvivalTime_Infection,
#  CombinedCohorts_Trimmed$BoostTime_Ind == 1 & CombinedCohorts_Trimmed$Boost2Time_Ind == 0 & CombinedCohorts_Trimmed$PosDuringBoost == 1 ~ CombinedCohorts_Trimmed$DaysSinceBirth_First_PositiveTestDiagnosis - CombinedCohorts_Trimmed$DaysSinceBirth_FullyBoosted_14,
#  TRUE ~ NA_real_
#)

# Full vaccination survival time
FV_SurvivalTime_Infection <- case_when(
###  CombinedCohorts_Trimmed$FVTime_Ind == 1 & CombinedCohorts_Trimmed$BoostTime_Ind == 0 & CombinedCohorts_Trimmed$PosDuringFV == 0 & CombinedCohorts_Trimmed$DaysFVtoLastEHR == 0 ~ CombinedCohorts_Trimmed$DaysFVtoPull,
###  CombinedCohorts_Trimmed$FVTime_Ind == 1 & CombinedCohorts_Trimmed$BoostTime_Ind == 1 & CombinedCohorts_Trimmed$PosDuringFV == 0 & CombinedCohorts_Trimmed$DaysFVtoLastEHR == 0 ~ CombinedCohorts_Trimmed$DaysFVtoPull - Booster_SurvivalTime_Infection,
  CombinedCohorts_Trimmed$FVTime_Ind == 1 & CombinedCohorts_Trimmed$BoostTime_Ind == 0 & CombinedCohorts_Trimmed$PosDuringFV == 0 & CombinedCohorts_Trimmed$DaysFVtoLastEHR > 0 ~ as.numeric(CombinedCohorts_Trimmed$DaysFVtoLastEHR),
  CombinedCohorts_Trimmed$FVTime_Ind == 1 & CombinedCohorts_Trimmed$BoostTime_Ind == 1 & CombinedCohorts_Trimmed$PosDuringFV == 0 & CombinedCohorts_Trimmed$DaysFVtoLastEHR > 0 ~ as.numeric(CombinedCohorts_Trimmed$DaysFVtoLastEHR) - Booster_SurvivalTime_Infection,
  CombinedCohorts_Trimmed$FVTime_Ind == 1 & CombinedCohorts_Trimmed$BoostTime_Ind == 0 & CombinedCohorts_Trimmed$PosDuringFV == 1 ~ CombinedCohorts_Trimmed$DaysSinceBirth_First_PositiveTestDiagnosis - CombinedCohorts_Trimmed$DaysSinceBirth_FullyVaccinated_14,
  TRUE ~ NA_real_
)

# Need to change based on pull date
# Current date is Sep 1, 2022
# First COVID vaccine EUA is Dec 11, 2020
# Used start of Q4 2021 for booster start date
# REMOVING THIS FOR NOW
# ONLY REMOVES INDIVIDUALS WHO STARTED EARLY BUT AVOIDED INFECTION
# LEAVES THOSE WHO STARTED EARLY BUT WERE INFECTED
#FV_SurvivalTime_Infection[FV_SurvivalTime_Infection > FV_MaxTime] <- NA
#Booster_SurvivalTime_Infection[Booster_SurvivalTime_Infection > Booster_MaxTime] <- NA
#Booster2_SurvivalTime_Infection[Booster2_SurvivalTime_Infection > Booster2_MaxTime] <- NA
#Booster3_SurvivalTime_Infection[Booster3_SurvivalTime_Infection > Booster2_MaxTime] <- NA

# Changing negative values to NA
FV_SurvivalTime_Infection[FV_SurvivalTime_Infection < 0] <- NA
Booster_SurvivalTime_Infection[Booster_SurvivalTime_Infection < 0] <- NA
Booster2_SurvivalTime_Infection[Booster2_SurvivalTime_Infection < 0] <- NA
Booster3_SurvivalTime_Infection[Booster3_SurvivalTime_Infection < 0] <- NA
```

```{r}
# Total (FV plus first booster) survival time for infection
Total_SurvivalTime_Infection <- case_when(
  !is.na(FV_SurvivalTime_Infection) & !is.na(Booster_SurvivalTime_Infection) ~ FV_SurvivalTime_Infection + Booster_SurvivalTime_Infection,
  !is.na(FV_SurvivalTime_Infection) & is.na(Booster_SurvivalTime_Infection) ~ FV_SurvivalTime_Infection,
  is.na(FV_SurvivalTime_Infection) & !is.na(Booster_SurvivalTime_Infection) ~ Booster_SurvivalTime_Infection,
  TRUE ~ NA_real_
)
```

```{r}
# Add survival time variables to dataset
CombinedCohorts_Trimmed <- CombinedCohorts_Trimmed %>%
  mutate(FV_SurvivalTime_Infection = FV_SurvivalTime_Infection) %>%
  mutate(Booster_SurvivalTime_Infection = Booster_SurvivalTime_Infection) %>%
  mutate(Total_SurvivalTime_Infection = Total_SurvivalTime_Infection) %>%
  mutate(Booster2_SurvivalTime_Infection = Booster2_SurvivalTime_Infection) %>%
  mutate(Booster23_SurvivalTime_Infection = Booster3_SurvivalTime_Infection)
```

```{r}
# Adding last quarter at risk for full vaccinated and boosted
CombinedCohorts_Trimmed <- CombinedCohorts_Trimmed %>%
  mutate(LastYearQuarter_FVAtRisk = YearQuarter_FV + FV_SurvivalTime_Infection %/% 91) %>%
  mutate(LastYearQuarter_BoosterAtRisk = YearQuarter_Booster + Booster_SurvivalTime_Infection %/% 91) %>%
  mutate(LastYearQuarter_Booster2AtRisk = YearQuarter_Booster2 + Booster2_SurvivalTime_Infection %/% 91)
```

```{r}
# Making quarter at risk variables for full vaccinated
CombinedCohorts_Trimmed <- CombinedCohorts_Trimmed %>%
  mutate(Y2020Q4_FVAtRisk = as.factor(ifelse(1 >= YearQuarter_FV & 1 <= LastYearQuarter_FVAtRisk, yes = 1, no = 0))) %>%
  mutate(Y2021Q1_FVAtRisk = as.factor(ifelse(2 >= YearQuarter_FV & 2 <= LastYearQuarter_FVAtRisk, yes = 1, no = 0))) %>%
  mutate(Y2021Q2_FVAtRisk = as.factor(ifelse(3 >= YearQuarter_FV & 3 <= LastYearQuarter_FVAtRisk, yes = 1, no = 0))) %>%
  mutate(Y2021Q3_FVAtRisk = as.factor(ifelse(4 >= YearQuarter_FV & 4 <= LastYearQuarter_FVAtRisk, yes = 1, no = 0))) %>%
  mutate(Y2021Q4_FVAtRisk = as.factor(ifelse(5 >= YearQuarter_FV & 5 <= LastYearQuarter_FVAtRisk, yes = 1, no = 0))) %>%
  mutate(Y2022Q1_FVAtRisk = as.factor(ifelse(6 >= YearQuarter_FV & 6 <= LastYearQuarter_FVAtRisk, yes = 1, no = 0))) %>%
  mutate(Y2022Q2_FVAtRisk = as.factor(ifelse(7 >= YearQuarter_FV & 7 <= LastYearQuarter_FVAtRisk, yes = 1, no = 0))) %>%
  mutate(Y2022Q3_FVAtRisk = as.factor(ifelse(8 >= YearQuarter_FV & 8 <= LastYearQuarter_FVAtRisk, yes = 1, no = 0)))
```

```{r}
# Making quarter at risk variables for boosted
CombinedCohorts_Trimmed <- CombinedCohorts_Trimmed %>%
  mutate(Y2021Q4_BoosterAtRisk = as.factor(ifelse(5 >= YearQuarter_Booster & 5 <= LastYearQuarter_BoosterAtRisk, yes = 1, no = 0))) %>%
  mutate(Y2022Q1_BoosterAtRisk = as.factor(ifelse(6 >= YearQuarter_Booster & 6 <= LastYearQuarter_BoosterAtRisk, yes = 1, no = 0))) %>%
  mutate(Y2022Q2_BoosterAtRisk = as.factor(ifelse(7 >= YearQuarter_Booster & 7 <= LastYearQuarter_BoosterAtRisk, yes = 1, no = 0))) %>%
  mutate(Y2022Q3_BoosterAtRisk = as.factor(ifelse(8 >= YearQuarter_Booster & 8 <= LastYearQuarter_BoosterAtRisk, yes = 1, no = 0)))
```

```{r}
# Making quarter at risk variables for second boosted
CombinedCohorts_Trimmed <- CombinedCohorts_Trimmed %>%
  mutate(Y2022Q2_Booster2AtRisk = as.factor(ifelse(7 >= YearQuarter_Booster2 & 7 <= LastYearQuarter_Booster2AtRisk, yes = 1, no = 0))) %>%
  mutate(Y2022Q3_Booster2AtRisk = as.factor(ifelse(8 >= YearQuarter_Booster2 & 8 <= LastYearQuarter_Booster2AtRisk, yes = 1, no = 0)))
```


```{r}
# Hospitalization survival time
# Based on conditional end of study censoring

Booster_SurvivalTime_Hosp <- case_when(
#  CombinedCohorts_Trimmed$BoostTime_Ind == 1 & CombinedCohorts_Trimmed$PosDuringBoost == 0 & CombinedCohorts_Trimmed$DaysBoostertoLastEHR == 0 ~ CombinedCohorts_Trimmed$DaysBoostertoPull,
  CombinedCohorts_Trimmed$BoostTime_Ind == 1 & CombinedCohorts_Trimmed$PosDuringBoost == 0 & CombinedCohorts_Trimmed$DaysBoostertoLastEHR > 0 ~ as.numeric(CombinedCohorts_Trimmed$DaysBoostertoLastEHR),
  CombinedCohorts_Trimmed$BoostTime_Ind == 1 & CombinedCohorts_Trimmed$PosDuringBoost == 1 ~ CombinedCohorts_Trimmed$DaysSinceBirth_First_PositiveTestDiagnosis - CombinedCohorts_Trimmed$DaysSinceBirth_FullyBoosted_14,
  TRUE ~ NA_real_
)

FV_SurvivalTime_Hosp <- case_when(
#  CombinedCohorts_Trimmed$FVTime_Ind == 1 & CombinedCohorts_Trimmed$BoostTime_Ind == 0 & CombinedCohorts_Trimmed$PosDuringFV == 0 & CombinedCohorts_Trimmed$DaysFVtoLastEHR == 0 ~ CombinedCohorts_Trimmed$DaysFVtoPull,
#  CombinedCohorts_Trimmed$FVTime_Ind == 1 & CombinedCohorts_Trimmed$BoostTime_Ind == 1 & CombinedCohorts_Trimmed$PosDuringFV == 0 & CombinedCohorts_Trimmed$DaysFVtoLastEHR == 0 ~ CombinedCohorts_Trimmed$DaysFVtoPull - Booster_SurvivalTime_Hosp,
  CombinedCohorts_Trimmed$FVTime_Ind == 1 & CombinedCohorts_Trimmed$BoostTime_Ind == 0 & CombinedCohorts_Trimmed$PosDuringFV == 0 & CombinedCohorts_Trimmed$DaysFVtoLastEHR > 0 ~ as.numeric(CombinedCohorts_Trimmed$DaysFVtoLastEHR),
  CombinedCohorts_Trimmed$FVTime_Ind == 1 & CombinedCohorts_Trimmed$BoostTime_Ind == 1 & CombinedCohorts_Trimmed$PosDuringFV == 0 & CombinedCohorts_Trimmed$DaysFVtoLastEHR > 0 ~ as.numeric(CombinedCohorts_Trimmed$DaysFVtoLastEHR) - Booster_SurvivalTime_Hosp,
  CombinedCohorts_Trimmed$FVTime_Ind == 1 & CombinedCohorts_Trimmed$PosDuringFV == 1 ~ CombinedCohorts_Trimmed$DaysSinceBirth_First_PositiveTestDiagnosis - CombinedCohorts_Trimmed$DaysSinceBirth_FullyVaccinated_14,
  TRUE ~ NA_real_
)

# Need to change based on pull date
# Current date is Sep 1, 2022
# First COVID vaccine EUA is Dec 11, 2020
# Used start of Q4 2021 for booster start date
#FV_SurvivalTime_Hosp[FV_SurvivalTime_Hosp > FV_MaxTime] <- NA
#Booster_SurvivalTime_Hosp[Booster_SurvivalTime_Hosp > Booster_MaxTime] <- NA
```

```{r}
# Total survival time for hospitalization
Total_SurvivalTime_Hosp <- case_when(
  !is.na(FV_SurvivalTime_Hosp) & !is.na(Booster_SurvivalTime_Hosp) ~ FV_SurvivalTime_Hosp + Booster_SurvivalTime_Hosp,
  !is.na(FV_SurvivalTime_Hosp) & is.na(Booster_SurvivalTime_Hosp) ~ FV_SurvivalTime_Hosp,
  is.na(FV_SurvivalTime_Hosp) & !is.na(Booster_SurvivalTime_Hosp) ~ Booster_SurvivalTime_Hosp,
  TRUE ~ NA_real_
)
```

```{r}
# Add hospital survival time variables to dataset
CombinedCohorts_Trimmed <- CombinedCohorts_Trimmed %>%
  mutate(FV_SurvivalTime_Hosp = FV_SurvivalTime_Hosp) %>%
  mutate(Booster_SurvivalTime_Hosp = Booster_SurvivalTime_Hosp) %>%
  mutate(Total_SurvivalTime_Hosp = Total_SurvivalTime_Hosp)
```

#### Cap Function

```{r}
# Survival time cap function
SurvivalTime_Cap <- function(data, time_cap = 120){
  data_new <- data %>%
    mutate(Infection_InPeriod = case_when(
      SurvivalTime_Infection > time_cap ~ 0,
      TRUE ~ Infection_InPeriod
    )) %>%
    mutate(Hosp_InPeriod = case_when(
      SurvivalTime_Infection > time_cap ~ 0,
      TRUE ~ Hosp_InPeriod
    )) %>%
    mutate(Death_InPeriod = case_when(
      SurvivalTime_Infection > time_cap ~ 0,
      TRUE ~ Death_InPeriod
    )) %>%
    mutate(Severe_InPeriod = case_when(
      SurvivalTime_Infection > time_cap ~ 0,
      TRUE ~ Severe_InPeriod
    )) %>%
    mutate(SurvivalTime_Infection = case_when(
      SurvivalTime_Infection > time_cap ~ time_cap,
      TRUE ~ SurvivalTime_Infection
    ))
  return(data_new)
}
```

## Other Variables

```{r}
# Indicator for having any negative tests or not
CombinedCohorts_Trimmed <- CombinedCohorts_Trimmed %>%
  mutate(negativeTests_Ind = as.factor(ifelse(!is.na(negativeTests) & negativeTests > 0, yes = 1, no = 0)))
```

```{r}
# Primary care at MM indicator
CombinedCohorts_Trimmed <- CombinedCohorts_Trimmed %>%
  mutate(PrimaryCareMM_Ind = ifelse(PrimaryCareMM_YN == "No" | is.na(PrimaryCareMM_YN), yes = 0, no = 1))
```

```{r}
# Negative Tests Categories
negativeTests_Cat <- case_when(CombinedCohorts_Trimmed$negativeTests == 0 | is.na(CombinedCohorts_Trimmed$negativeTests) ~ "0",
                               CombinedCohorts_Trimmed$negativeTests == 1 ~ "1",
                               CombinedCohorts_Trimmed$negativeTests %in% 2:3 ~ "2-3",
                               CombinedCohorts_Trimmed$negativeTests %in% 4:5 ~ "4-5",
                               CombinedCohorts_Trimmed$negativeTests %in% 6:10 ~ "6-10",
                               CombinedCohorts_Trimmed$negativeTests > 10 ~ "11+")
negativeTests_Cat <- factor(negativeTests_Cat, levels = c("0", "1", "2-3", "4-5", "6-10", "11+"))
CombinedCohorts_Trimmed <- CombinedCohorts_Trimmed %>%
  mutate(negativeTests_Cat = negativeTests_Cat)
```


```{r}
# Make dataframe with only those who received primary care at MM 
# For sensitivity analyses
CombinedCohorts_PrimaryCare <- CombinedCohorts_Trimmed %>%
  filter(PrimaryCareMM_YN == "Yes") %>%
  filter(UncertainDiagnosisData != 1 | is.na(UncertainDiagnosisData))
```

## Per 60 days variables

```{r}
DaysSinceFV_Infection <- ifelse(CombinedCohorts_Trimmed$FVTime_Ind == 1 & CombinedCohorts_Trimmed$PosDuringFV == 1 | CombinedCohorts_Trimmed$BoostTime_Ind == 1 & CombinedCohorts_Trimmed$PosDuringBoost == 1, 
                                yes = CombinedCohorts_Trimmed$DaysSinceBirth_First_PositiveTestDiagnosis - CombinedCohorts_Trimmed$DaysSinceBirth_FullyVaccinated_14,
                                no = NA)
```

```{r}
Int60_1_FVSurvivalTime <- case_when(
  CombinedCohorts_Trimmed$FV_SurvivalTime_Infection - 180 > 60 ~ 60,
  (CombinedCohorts_Trimmed$FV_SurvivalTime_Infection - 180) %in% 1:60 ~ CombinedCohorts_Trimmed$FV_SurvivalTime_Infection - 180,
  CombinedCohorts_Trimmed$FV_SurvivalTime_Infection - 180 < 0 ~ NA_real_
)
Int60_1_SurvivalTime <- case_when(
  !is.na(Int60_1_FVSurvivalTime) ~ Int60_1_FVSurvivalTime,
  is.na(Int60_1_FVSurvivalTime) & CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 > 60 ~ 60,
  is.na(Int60_1_FVSurvivalTime) & (CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180) %in% 1:60 ~ CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180,
  is.na(Int60_1_FVSurvivalTime) & CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 < 0 ~ NA_real_
)
Int60_1_Booster <- as.factor(case_when(
  CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 < CombinedCohorts_Trimmed$Booster_SurvivalTime_Infection & CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 > 0 ~ 1,
  CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 > CombinedCohorts_Trimmed$Booster_SurvivalTime_Infection & CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 > 0 ~ 0
))
Int60_1_Infection <- case_when(
  CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 > 60 ~ 0,
  (CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180) %in% 1:60 & CombinedCohorts_Trimmed$BoostTime_Ind == 0 ~ CombinedCohorts_Trimmed$PosDuringFV,
  (CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180) %in% 1:60 & CombinedCohorts_Trimmed$BoostTime_Ind == 1 ~ CombinedCohorts_Trimmed$PosDuringBoost,
  CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 < 0 ~ NA_real_
)
Int60_1_Hospitalization <- case_when(
  CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 > 60 ~ 0,
  (CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180) %in% 1:60 & CombinedCohorts_Trimmed$BoostTime_Ind == 0 ~ CombinedCohorts_Trimmed$HosDuringFV,
  (CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180) %in% 1:60 & CombinedCohorts_Trimmed$BoostTime_Ind == 1 ~ CombinedCohorts_Trimmed$HosDuringBoost,
  CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 < 0 ~ NA_real_
)
```

```{r}
tab_infection <- table(Int60_1_Booster, Int60_1_Infection)
tab_infection
tab_infection[2,2] * tab_infection[1,1] / (tab_infection[1,2] * tab_infection[2,1])
tab_hospitalization <- table(Int60_1_Booster, Int60_1_Hospitalization)
tab_hospitalization
tab_hospitalization[2,2] * tab_hospitalization[1,1] / (tab_hospitalization[1,2] * tab_hospitalization[2,1])
```


```{r}
DelayDays <- 60
Int60_2_FVSurvivalTime <- case_when(
  CombinedCohorts_Trimmed$FV_SurvivalTime_Infection - 180 - DelayDays > 60 ~ 60,
  (CombinedCohorts_Trimmed$FV_SurvivalTime_Infection - 180 - DelayDays) %in% 1:60 ~ CombinedCohorts_Trimmed$FV_SurvivalTime_Infection - 180 - DelayDays,
  CombinedCohorts_Trimmed$FV_SurvivalTime_Infection - 180 - DelayDays < 0 ~ NA_real_
)
Int60_2_SurvivalTime <- case_when(
  !is.na(Int60_2_FVSurvivalTime) ~ Int60_2_FVSurvivalTime,
  is.na(Int60_2_FVSurvivalTime) & CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays > 60 ~ 60,
  is.na(Int60_2_FVSurvivalTime) & (CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays) %in% 1:60 ~ CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays,
  is.na(Int60_2_FVSurvivalTime) & CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays < 0 ~ NA_real_
)
Int60_2_Booster <- as.factor(case_when(
  CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays < CombinedCohorts_Trimmed$Booster_SurvivalTime_Infection & CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays > 0 ~ 1,
  CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays > CombinedCohorts_Trimmed$Booster_SurvivalTime_Infection & CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays > 0 ~ 0
))
Int60_2_Infection <- case_when(
  CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays > 60 ~ 0,
  (CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays) %in% 1:60 & CombinedCohorts_Trimmed$BoostTime_Ind == 0 ~ CombinedCohorts_Trimmed$PosDuringFV,
  (CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays) %in% 1:60 & CombinedCohorts_Trimmed$BoostTime_Ind == 1 ~ CombinedCohorts_Trimmed$PosDuringBoost,
  CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays < 0 ~ NA_real_
)
Int60_2_Hospitalization <- case_when(
  CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays > 60 ~ 0,
  (CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays) %in% 1:60 & CombinedCohorts_Trimmed$BoostTime_Ind == 0 ~ CombinedCohorts_Trimmed$HosDuringFV,
  (CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays) %in% 1:60 & CombinedCohorts_Trimmed$BoostTime_Ind == 1 ~ CombinedCohorts_Trimmed$HosDuringBoost,
  CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays < 0 ~ NA_real_
)
```

```{r}
tab_infection <- table(Int60_2_Booster, Int60_2_Infection)
tab_infection
tab_infection[2,2] * tab_infection[1,1] / (tab_infection[1,2] * tab_infection[2,1])
tab_hospitalization <- table(Int60_2_Booster, Int60_2_Hospitalization)
tab_hospitalization
tab_hospitalization[2,2] * tab_hospitalization[1,1] / (tab_hospitalization[1,2] * tab_hospitalization[2,1])
```

```{r}
DelayDays <- 120
Int60_3_FVSurvivalTime <- case_when(
  CombinedCohorts_Trimmed$FV_SurvivalTime_Infection - 180 - DelayDays > 60 ~ 60,
  (CombinedCohorts_Trimmed$FV_SurvivalTime_Infection - 180 - DelayDays) %in% 1:60 ~ CombinedCohorts_Trimmed$FV_SurvivalTime_Infection - 180 - DelayDays,
  CombinedCohorts_Trimmed$FV_SurvivalTime_Infection - 180 - DelayDays < 0 ~ NA_real_
)
Int60_3_SurvivalTime <- case_when(
  !is.na(Int60_3_FVSurvivalTime) ~ Int60_3_FVSurvivalTime,
  is.na(Int60_3_FVSurvivalTime) & CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays > 60 ~ 60,
  is.na(Int60_3_FVSurvivalTime) & (CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays) %in% 1:60 ~ CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays,
  is.na(Int60_3_FVSurvivalTime) & CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays < 0 ~ NA_real_
)
Int60_3_Booster <- as.factor(case_when(
  CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays < CombinedCohorts_Trimmed$Booster_SurvivalTime_Infection & CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays > 0 ~ 1,
  CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays > CombinedCohorts_Trimmed$Booster_SurvivalTime_Infection & CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays > 0 ~ 0
))
Int60_3_Infection <- case_when(
  CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays > 60 ~ 0,
  (CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays) %in% 1:60 & CombinedCohorts_Trimmed$BoostTime_Ind == 0 ~ CombinedCohorts_Trimmed$PosDuringFV,
  (CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays) %in% 1:60 & CombinedCohorts_Trimmed$BoostTime_Ind == 1 ~ CombinedCohorts_Trimmed$PosDuringBoost,
  CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays < 0 ~ NA_real_
)
Int60_3_Hospitalization <- case_when(
  CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays > 60 ~ 0,
  (CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays) %in% 1:60 & CombinedCohorts_Trimmed$BoostTime_Ind == 0 ~ CombinedCohorts_Trimmed$HosDuringFV,
  (CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays) %in% 1:60 & CombinedCohorts_Trimmed$BoostTime_Ind == 1 ~ CombinedCohorts_Trimmed$HosDuringBoost,
  CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays < 0 ~ NA_real_
)
```

```{r}
tab_infection <- table(Int60_3_Booster, Int60_3_Infection)
tab_infection
tab_infection[2,2] * tab_infection[1,1] / (tab_infection[1,2] * tab_infection[2,1])
tab_hospitalization <- table(Int60_3_Booster, Int60_3_Hospitalization)
tab_hospitalization
tab_hospitalization[2,2] * tab_hospitalization[1,1] / (tab_hospitalization[1,2] * tab_hospitalization[2,1])
```

```{r}
DelayDays <- 180
Int60_4_FVSurvivalTime <- case_when(
  CombinedCohorts_Trimmed$FV_SurvivalTime_Infection - 180 - DelayDays > 60 ~ 60,
  (CombinedCohorts_Trimmed$FV_SurvivalTime_Infection - 180 - DelayDays) %in% 1:60 ~ CombinedCohorts_Trimmed$FV_SurvivalTime_Infection - 180 - DelayDays,
  CombinedCohorts_Trimmed$FV_SurvivalTime_Infection - 180 - DelayDays < 0 ~ NA_real_
)
Int60_4_SurvivalTime <- case_when(
  !is.na(Int60_4_FVSurvivalTime) ~ Int60_4_FVSurvivalTime,
  is.na(Int60_4_FVSurvivalTime) & CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays > 60 ~ 60,
  is.na(Int60_4_FVSurvivalTime) & (CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays) %in% 1:60 ~ CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays,
  is.na(Int60_4_FVSurvivalTime) & CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays < 0 ~ NA_real_
)
Int60_4_Booster <- as.factor(case_when(
  CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays < CombinedCohorts_Trimmed$Booster_SurvivalTime_Infection & CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays > 0 ~ 1,
  CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays > CombinedCohorts_Trimmed$Booster_SurvivalTime_Infection & CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays > 0 ~ 0
))
Int60_4_Infection <- case_when(
  CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays > 60 ~ 0,
  (CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays) %in% 1:60 & CombinedCohorts_Trimmed$BoostTime_Ind == 0 ~ CombinedCohorts_Trimmed$PosDuringFV,
  (CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays) %in% 1:60 & CombinedCohorts_Trimmed$BoostTime_Ind == 1 ~ CombinedCohorts_Trimmed$PosDuringBoost,
  CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays < 0 ~ NA_real_
)
Int60_4_Hospitalization <- case_when(
  CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays > 60 ~ 0,
  (CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays) %in% 1:60 & CombinedCohorts_Trimmed$BoostTime_Ind == 0 ~ CombinedCohorts_Trimmed$HosDuringFV,
  (CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays) %in% 1:60 & CombinedCohorts_Trimmed$BoostTime_Ind == 1 ~ CombinedCohorts_Trimmed$HosDuringBoost,
  CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays < 0 ~ NA_real_
)
```

```{r}
tab_infection <- table(Int60_4_Booster, Int60_4_Infection)
tab_infection
tab_infection[2,2] * tab_infection[1,1] / (tab_infection[1,2] * tab_infection[2,1])
tab_hospitalization <- table(Int60_4_Booster, Int60_4_Hospitalization)
tab_hospitalization
tab_hospitalization[2,2] * tab_hospitalization[1,1] / (tab_hospitalization[1,2] * tab_hospitalization[2,1])
```

```{r}
DelayDays <- 240
Int60_5_FVSurvivalTime <- case_when(
  CombinedCohorts_Trimmed$FV_SurvivalTime_Infection - 180 - DelayDays > 60 ~ 60,
  (CombinedCohorts_Trimmed$FV_SurvivalTime_Infection - 180 - DelayDays) %in% 1:60 ~ CombinedCohorts_Trimmed$FV_SurvivalTime_Infection - 180 - DelayDays,
  CombinedCohorts_Trimmed$FV_SurvivalTime_Infection - 180 - DelayDays < 0 ~ NA_real_
)
Int60_5_SurvivalTime <- case_when(
  !is.na(Int60_5_FVSurvivalTime) ~ Int60_5_FVSurvivalTime,
  is.na(Int60_5_FVSurvivalTime) & CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays > 60 ~ 60,
  is.na(Int60_5_FVSurvivalTime) & (CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays) %in% 1:60 ~ CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays,
  is.na(Int60_5_FVSurvivalTime) & CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays < 0 ~ NA_real_
)
Int60_5_Booster <- as.factor(case_when(
  CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays < CombinedCohorts_Trimmed$Booster_SurvivalTime_Infection & CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays > 0 ~ 1,
  CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays > CombinedCohorts_Trimmed$Booster_SurvivalTime_Infection & CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays > 0 ~ 0
))
Int60_5_Infection <- case_when(
  CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays > 60 ~ 0,
  (CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays) %in% 1:60 & CombinedCohorts_Trimmed$BoostTime_Ind == 0 ~ CombinedCohorts_Trimmed$PosDuringFV,
  (CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays) %in% 1:60 & CombinedCohorts_Trimmed$BoostTime_Ind == 1 ~ CombinedCohorts_Trimmed$PosDuringBoost,
  CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays < 0 ~ NA_real_
)
Int60_5_Hospitalization <- case_when(
  CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays > 60 ~ 0,
  (CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays) %in% 1:60 & CombinedCohorts_Trimmed$BoostTime_Ind == 0 ~ CombinedCohorts_Trimmed$HosDuringFV,
  (CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays) %in% 1:60 & CombinedCohorts_Trimmed$BoostTime_Ind == 1 ~ CombinedCohorts_Trimmed$HosDuringBoost,
  CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays < 0 ~ NA_real_
)
```

```{r}
tab_infection <- table(Int60_5_Booster, Int60_5_Infection)
tab_infection
tab_infection[2,2] * tab_infection[1,1] / (tab_infection[1,2] * tab_infection[2,1])
tab_hospitalization <- table(Int60_5_Booster, Int60_5_Hospitalization)
tab_hospitalization
tab_hospitalization[2,2] * tab_hospitalization[1,1] / (tab_hospitalization[1,2] * tab_hospitalization[2,1])
```

```{r}
DelayDays <- 300
Int60_6_FVSurvivalTime <- case_when(
  CombinedCohorts_Trimmed$FV_SurvivalTime_Infection - 180 - DelayDays > 60 ~ 60,
  (CombinedCohorts_Trimmed$FV_SurvivalTime_Infection - 180 - DelayDays) %in% 1:60 ~ CombinedCohorts_Trimmed$FV_SurvivalTime_Infection - 180 - DelayDays,
  CombinedCohorts_Trimmed$FV_SurvivalTime_Infection - 180 - DelayDays < 0 ~ NA_real_
)
Int60_6_SurvivalTime <- case_when(
  !is.na(Int60_6_FVSurvivalTime) ~ Int60_6_FVSurvivalTime,
  is.na(Int60_6_FVSurvivalTime) & CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays > 60 ~ 60,
  is.na(Int60_6_FVSurvivalTime) & (CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays) %in% 1:60 ~ CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays,
  is.na(Int60_6_FVSurvivalTime) & CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays < 0 ~ NA_real_
)
Int60_6_Booster <- as.factor(case_when(
  CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays < CombinedCohorts_Trimmed$Booster_SurvivalTime_Infection & CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays > 0 ~ 1,
  CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays > CombinedCohorts_Trimmed$Booster_SurvivalTime_Infection & CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays > 0 ~ 0
))
Int60_6_Infection <- case_when(
  CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays > 60 ~ 0,
  (CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays) %in% 1:60 & CombinedCohorts_Trimmed$BoostTime_Ind == 0 ~ CombinedCohorts_Trimmed$PosDuringFV,
  (CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays) %in% 1:60 & CombinedCohorts_Trimmed$BoostTime_Ind == 1 ~ CombinedCohorts_Trimmed$PosDuringBoost,
  CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays < 0 ~ NA_real_
)
Int60_6_Hospitalization <- case_when(
  CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays > 60 ~ 0,
  (CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays) %in% 1:60 & CombinedCohorts_Trimmed$BoostTime_Ind == 0 ~ CombinedCohorts_Trimmed$HosDuringFV,
  (CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays) %in% 1:60 & CombinedCohorts_Trimmed$BoostTime_Ind == 1 ~ CombinedCohorts_Trimmed$HosDuringBoost,
  CombinedCohorts_Trimmed$Total_SurvivalTime_Infection - 180 - DelayDays < 0 ~ NA_real_
)
```

```{r}
tab_infection <- table(Int60_6_Booster, Int60_6_Infection)
tab_infection
tab_infection[2,2] * tab_infection[1,1] / (tab_infection[1,2] * tab_infection[2,1])
tab_hospitalization <- table(Int60_6_Booster, Int60_6_Hospitalization)
tab_hospitalization
tab_hospitalization[2,2] * tab_hospitalization[1,1] / (tab_hospitalization[1,2] * tab_hospitalization[2,1])
```

```{r}
CombinedCohorts_Int60 <- CombinedCohorts_Trimmed %>%
  mutate(Int60_1_SurvivalTime, Int60_1_Booster, Int60_1_Infection, Int60_1_Hospitalization,
         Int60_2_SurvivalTime, Int60_2_Booster, Int60_2_Infection, Int60_2_Hospitalization,
         Int60_3_SurvivalTime, Int60_3_Booster, Int60_3_Infection, Int60_3_Hospitalization,
         Int60_4_SurvivalTime, Int60_4_Booster, Int60_4_Infection, Int60_4_Hospitalization,
         Int60_5_SurvivalTime, Int60_5_Booster, Int60_5_Infection, Int60_5_Hospitalization,
         Int60_6_SurvivalTime, Int60_6_Booster, Int60_6_Infection, Int60_6_Hospitalization)
```

## Quarter of Booster Stratification

```{r}
FV_SurvivalTime_Since_Quarter <- function(Quarter, Days_QuartertoPull){
  SurvivalTime <- ifelse(CombinedCohorts_Trimmed$YearQuarter_FV <= Quarter & (is.na(CombinedCohorts_Trimmed$YearQuarter_Booster) | CombinedCohorts_Trimmed$YearQuarter_Booster > Quarter), 
                                  yes = CombinedCohorts_Trimmed$FV_SurvivalTime_Infection - (Quarter - CombinedCohorts_Trimmed$YearQuarter_FV) * 91,
                                  no = NA
                                  )
  SurvivalTime <- ifelse(SurvivalTime > 0, yes = SurvivalTime, no = NA)
  SurvivalTime <- ifelse(SurvivalTime > Days_QuartertoPull, yes = NA, no = SurvivalTime)
  return(SurvivalTime)
}
```

```{r}
Booster_SurvivalTime_From_Quarter <- function(Quarter, Days_QuartertoPull){
  SurvivalTime <- ifelse(CombinedCohorts_Trimmed$YearQuarter_Booster == Quarter,
                                        yes = CombinedCohorts_Trimmed$Booster_SurvivalTime_Infection,
                                        no = NA)
  SurvivalTime <- ifelse(SurvivalTime > 0, yes = SurvivalTime, no = NA)
  SurvivalTime <- ifelse(SurvivalTime > Days_QuartertoPull, yes = NA, no = SurvivalTime)
  return(SurvivalTime)
}
```

```{r}
Booster_SurvivalTime_Since_Quarter <- function(Quarter, Days_QuartertoPull){
  SurvivalTime <- ifelse(CombinedCohorts_Trimmed$YearQuarter_Booster <= Quarter,
                                        yes = CombinedCohorts_Trimmed$Booster_SurvivalTime_Infection - (Quarter - CombinedCohorts_Trimmed$YearQuarter_Booster) * 91,
                                        no = NA)
  SurvivalTime <- ifelse(SurvivalTime > 0, yes = SurvivalTime, no = NA)
  SurvivalTime <- ifelse(SurvivalTime > Days_QuartertoPull, yes = NA, no = SurvivalTime)
  return(SurvivalTime)
}
```

```{r}
SecondBooster_SurvivalTime_From_Quarter <- function(Quarter, Days_QuartertoPull){
  SurvivalTime <- ifelse(CombinedCohorts_Trimmed$YearQuarter_Booster2 == Quarter,
                                        yes = CombinedCohorts_Trimmed$Booster2_SurvivalTime_Infection,
                                        no = NA)
  SurvivalTime <- ifelse(SurvivalTime > 0, yes = SurvivalTime, no = NA)
  SurvivalTime <- ifelse(SurvivalTime > Days_QuartertoPull, yes = NA, no = SurvivalTime)
  return(SurvivalTime)
}
```

```{r}
SecondBooster_SurvivalTime_Since_Quarter <- function(Quarter, Days_QuartertoPull){
  SurvivalTime <- ifelse(CombinedCohorts_Trimmed$YearQuarter_Booster2 <= Quarter,
                                        yes = CombinedCohorts_Trimmed$Booster2_SurvivalTime_Infection - (Quarter - CombinedCohorts_Trimmed$YearQuarter_Booster2) * 91,
                                        no = NA)
  SurvivalTime <- ifelse(SurvivalTime > 0, yes = SurvivalTime, no = NA)
  SurvivalTime <- ifelse(SurvivalTime > Days_QuartertoPull, yes = NA, no = SurvivalTime)
  return(SurvivalTime)
}
```

### Q4 2021

```{r}
# Q4 2021
# YearQuarter_Immune 5
Q42021_FV_SurvivalTime <- FV_SurvivalTime_Since_Quarter(Quarter = 5, Days_QuartertoPull = 335 + DayAdj)
Q42021_Booster_SurvivalTime <- Booster_SurvivalTime_From_Quarter(Quarter = 5, Days_QuartertoPull = 335 + DayAdj)
Q42021_Booster_SurvivalTime2 <- Booster_SurvivalTime_Since_Quarter(Quarter = 5, Days_QuartertoPull = 335 + DayAdj)
```

```{r}
Q42021_FV_Only <- CombinedCohorts_Trimmed %>%
  mutate(Q42021_FV_SurvivalTime) %>%
  mutate(Q42021_Booster_SurvivalTime) %>%
  filter(Q42021_FV_SurvivalTime > 0) %>%
  mutate(SurvivalTime_Infection = Q42021_FV_SurvivalTime) %>%
  mutate(Infection_InPeriod = PosDuringFV) %>%
  mutate(Hosp_InPeriod = HosDuringFV) %>%
  mutate(Death_InPeriod = DeathDuringFV) %>%
  mutate(Severe_InPeriod = SevereDuringFV) %>%
  mutate(Booster = 0) %>%
  mutate(YearQuarter_LastVaccination = YearQuarter_FV) %>%
  # Quarters at risk variables
  mutate(Y2021Q4_AtRisk = Y2021Q4_FVAtRisk) %>%
  mutate(Y2022Q1_AtRisk = Y2022Q1_FVAtRisk) %>%
  mutate(Y2022Q2_AtRisk = Y2022Q2_FVAtRisk) %>%
  mutate(Y2022Q3_AtRisk = Y2022Q3_FVAtRisk)

Q42021_Booster_Only <- CombinedCohorts_Trimmed %>%
  mutate(Q42021_FV_SurvivalTime) %>%
  mutate(Q42021_Booster_SurvivalTime) %>%
  filter(Q42021_Booster_SurvivalTime > 0) %>%
  mutate(SurvivalTime_Infection = Q42021_Booster_SurvivalTime) %>%
  mutate(Infection_InPeriod = PosDuringBoost) %>%
  mutate(Hosp_InPeriod = HosDuringBoost) %>%
  mutate(Death_InPeriod = DeathDuringBoost) %>%
  mutate(Severe_InPeriod = SevereDuringBoost) %>%
  mutate(Booster = 1) %>%
  mutate(YearQuarter_LastVaccination = YearQuarter_Booster) %>%
  # Quarters at risk variables
  mutate(Y2021Q4_AtRisk = Y2021Q4_BoosterAtRisk) %>%
  mutate(Y2022Q1_AtRisk = Y2022Q1_BoosterAtRisk) %>%
  mutate(Y2022Q2_AtRisk = Y2022Q2_BoosterAtRisk) %>%
  mutate(Y2022Q3_AtRisk = Y2022Q3_BoosterAtRisk)

Q42021_Cohort_Regression <- rbind.data.frame(Q42021_FV_Only, Q42021_Booster_Only) %>%
  filter(!is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(index))

#%>%
  # Only Primary Care at MM and No Uncertain Diagnosis Data
  #filter(PrimaryCareMM_YN == "Yes") %>%
  #filter(UncertainDiagnosisData != 1 | is.na(UncertainDiagnosisData))
```

```{r}
# Using since quarter instead of in quarter for booster
Q42021_FV_Only2 <- CombinedCohorts_Trimmed %>%
  mutate(Q42021_FV_SurvivalTime) %>%
  mutate(Q42021_Booster_SurvivalTime2) %>%
  filter(Q42021_FV_SurvivalTime > 0) %>%
  mutate(SurvivalTime_Infection = Q42021_FV_SurvivalTime) %>%
  mutate(Infection_InPeriod = PosDuringFV) %>%
  mutate(Hosp_InPeriod = HosDuringFV) %>%
  mutate(Death_InPeriod = DeathDuringFV) %>%
  mutate(Severe_InPeriod = SevereDuringFV) %>%
  mutate(Booster = 0) %>%
  mutate(YearQuarter_LastVaccination = YearQuarter_FV) %>%
  # Quarters at risk variables
  mutate(Y2021Q4_AtRisk = Y2021Q4_FVAtRisk) %>%
  mutate(Y2022Q1_AtRisk = Y2022Q1_FVAtRisk) %>%
  mutate(Y2022Q2_AtRisk = Y2022Q2_FVAtRisk) %>%
  mutate(Y2022Q3_AtRisk = Y2022Q3_FVAtRisk)

Q42021_Booster_Only2 <- CombinedCohorts_Trimmed %>%
  mutate(Q42021_FV_SurvivalTime) %>%
  mutate(Q42021_Booster_SurvivalTime2) %>%
  filter(Q42021_Booster_SurvivalTime2 > 0) %>%
  mutate(SurvivalTime_Infection = Q42021_Booster_SurvivalTime2) %>%
  mutate(Infection_InPeriod = PosDuringBoost) %>%
  mutate(Hosp_InPeriod = HosDuringBoost) %>%
  mutate(Death_InPeriod = DeathDuringBoost) %>%
  mutate(Severe_InPeriod = SevereDuringBoost) %>%
  mutate(Booster = 1) %>%
  mutate(YearQuarter_LastVaccination = YearQuarter_Booster) %>%
  # Quarters at risk variables
  mutate(Y2021Q4_AtRisk = Y2021Q4_BoosterAtRisk) %>%
  mutate(Y2022Q1_AtRisk = Y2022Q1_BoosterAtRisk) %>%
  mutate(Y2022Q2_AtRisk = Y2022Q2_BoosterAtRisk) %>%
  mutate(Y2022Q3_AtRisk = Y2022Q3_BoosterAtRisk)

Q42021_Cohort_Regression2 <- rbind.data.frame(Q42021_FV_Only2, Q42021_Booster_Only2) %>%
  filter(!is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(index))

#%>%
  # Only Primary Care at MM and No Uncertain Diagnosis Data
  #filter(PrimaryCareMM_YN == "Yes") %>%
  #filter(UncertainDiagnosisData != 1 | is.na(UncertainDiagnosisData))
```

### Q1 2022

```{r}
# Q1 2022
# YearQuarter_Immune 6
Q12022_FV_SurvivalTime <- FV_SurvivalTime_Since_Quarter(Quarter = 6, Days_QuartertoPull = 243 + DayAdj)
Q12022_Booster_SurvivalTime <- Booster_SurvivalTime_From_Quarter(Quarter = 6, Days_QuartertoPull = 243 + DayAdj)
Q12022_Booster_SurvivalTime2 <- Booster_SurvivalTime_Since_Quarter(Quarter = 6, Days_QuartertoPull = 243 + DayAdj)
```

```{r}
Q12022_FV_Only <- CombinedCohorts_Trimmed %>%
  mutate(Q12022_FV_SurvivalTime) %>%
  mutate(Q12022_Booster_SurvivalTime) %>%
  filter(Q12022_FV_SurvivalTime > 0) %>%
  mutate(SurvivalTime_Infection = Q12022_FV_SurvivalTime) %>%
  mutate(Infection_InPeriod = PosDuringFV) %>%
  mutate(Hosp_InPeriod = HosDuringFV) %>%
  mutate(Death_InPeriod = DeathDuringFV) %>%
  mutate(Severe_InPeriod = SevereDuringFV) %>%
  mutate(Booster = 0) %>%
  mutate(YearQuarter_LastVaccination = YearQuarter_FV) %>%
  # Quarters at risk variables
  mutate(Y2022Q1_AtRisk = Y2022Q1_FVAtRisk) %>%
  mutate(Y2022Q2_AtRisk = Y2022Q2_FVAtRisk) %>%
  mutate(Y2022Q3_AtRisk = Y2022Q3_FVAtRisk)

Q12022_Booster_Only <- CombinedCohorts_Trimmed %>%
  mutate(Q12022_FV_SurvivalTime) %>%
  mutate(Q12022_Booster_SurvivalTime) %>%
  filter(Q12022_Booster_SurvivalTime > 0) %>%
  mutate(SurvivalTime_Infection = Q12022_Booster_SurvivalTime) %>%
  mutate(Infection_InPeriod = PosDuringBoost) %>%
  mutate(Hosp_InPeriod = HosDuringBoost) %>%
  mutate(Death_InPeriod = DeathDuringBoost) %>%
  mutate(Severe_InPeriod = SevereDuringBoost) %>%
  mutate(Booster = 1) %>%
  mutate(YearQuarter_LastVaccination = YearQuarter_Booster) %>%
  # Quarters at risk variables
  mutate(Y2022Q1_AtRisk = Y2022Q1_BoosterAtRisk) %>%
  mutate(Y2022Q2_AtRisk = Y2022Q2_BoosterAtRisk) %>%
  mutate(Y2022Q3_AtRisk = Y2022Q3_BoosterAtRisk)

Q12022_Cohort_Regression <- rbind.data.frame(Q12022_FV_Only, Q12022_Booster_Only) %>%
  filter(!is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(index))

#%>%
  # Only Primary Care at MM and No Uncertain Diagnosis Data
  #filter(PrimaryCareMM_YN == "Yes") %>%
  #filter(UncertainDiagnosisData != 1 | is.na(UncertainDiagnosisData))
```

```{r}
# Using since quarter instead of in quarter for booster
Q12022_FV_Only2 <- CombinedCohorts_Trimmed %>%
  mutate(Q12022_FV_SurvivalTime) %>%
  mutate(Q12022_Booster_SurvivalTime2) %>%
  filter(Q12022_FV_SurvivalTime > 0) %>%
  mutate(SurvivalTime_Infection = Q12022_FV_SurvivalTime) %>%
  mutate(Infection_InPeriod = PosDuringFV) %>%
  mutate(Hosp_InPeriod = HosDuringFV) %>%
  mutate(Death_InPeriod = DeathDuringFV) %>%
  mutate(Severe_InPeriod = SevereDuringFV) %>%
  mutate(Booster = 0) %>%
  mutate(YearQuarter_LastVaccination = YearQuarter_FV) %>%
  # Quarters at risk variables
  mutate(Y2022Q1_AtRisk = Y2022Q1_FVAtRisk) %>%
  mutate(Y2022Q2_AtRisk = Y2022Q2_FVAtRisk) %>%
  mutate(Y2022Q3_AtRisk = Y2022Q3_FVAtRisk)

Q12022_Booster_Only2 <- CombinedCohorts_Trimmed %>%
  mutate(Q12022_FV_SurvivalTime) %>%
  mutate(Q12022_Booster_SurvivalTime2) %>%
  filter(Q12022_Booster_SurvivalTime2 > 0) %>%
  mutate(SurvivalTime_Infection = Q12022_Booster_SurvivalTime2) %>%
  mutate(Infection_InPeriod = PosDuringBoost) %>%
  mutate(Hosp_InPeriod = HosDuringBoost) %>%
  mutate(Death_InPeriod = DeathDuringBoost) %>%
  mutate(Severe_InPeriod = SevereDuringBoost) %>%
  mutate(Booster = 1) %>%
  mutate(YearQuarter_LastVaccination = YearQuarter_Booster) %>%
  # Quarters at risk variables
  mutate(Y2022Q1_AtRisk = Y2022Q1_BoosterAtRisk) %>%
  mutate(Y2022Q2_AtRisk = Y2022Q2_BoosterAtRisk) %>%
  mutate(Y2022Q3_AtRisk = Y2022Q3_BoosterAtRisk)

Q12022_Cohort_Regression2 <- rbind.data.frame(Q12022_FV_Only2, Q12022_Booster_Only2) %>%
  filter(!is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(index))

#%>%
  # Only Primary Care at MM and No Uncertain Diagnosis Data
  #filter(PrimaryCareMM_YN == "Yes") %>%
  #filter(UncertainDiagnosisData != 1 | is.na(UncertainDiagnosisData))
```

### Q2 2022

```{r}
# Q2 2022
# YearQuarter_Immune 7
Q22022_FV_SurvivalTime <- FV_SurvivalTime_Since_Quarter(Quarter = 7, Days_QuartertoPull = 153 + DayAdj)
Q22022_Booster_SurvivalTime <- Booster_SurvivalTime_From_Quarter(Quarter = 7, Days_QuartertoPull = 153 + DayAdj)
Q22022_Booster_SurvivalTime2 <- Booster_SurvivalTime_Since_Quarter(Quarter = 7, Days_QuartertoPull = 153 + DayAdj)

Q22022_Booster2_SurvivalTime <- SecondBooster_SurvivalTime_From_Quarter(Quarter = 7, Days_QuartertoPull = 153 + DayAdj)
Q22022_Booster2_SurvivalTime2 <- SecondBooster_SurvivalTime_Since_Quarter(Quarter = 7, Days_QuartertoPull = 153 + DayAdj)
```

```{r}
Q22022_FV_Only <- CombinedCohorts_Trimmed %>%
  mutate(Q22022_FV_SurvivalTime) %>%
  mutate(Q22022_Booster_SurvivalTime) %>%
  mutate(Q22022_Booster2_SurvivalTime) %>%
  filter(Q22022_FV_SurvivalTime > 0) %>%
  mutate(SurvivalTime_Infection = Q22022_FV_SurvivalTime) %>%
  mutate(Infection_InPeriod = PosDuringFV) %>%
  mutate(Hosp_InPeriod = HosDuringFV) %>%
  mutate(Death_InPeriod = DeathDuringFV) %>%
  mutate(Severe_InPeriod = SevereDuringFV) %>%
  mutate(Booster = 0) %>%
  mutate(Booster2 = 0) %>%
  mutate(YearQuarter_LastVaccination = YearQuarter_FV) %>%
  # Quarters at risk variables
  mutate(Y2022Q2_AtRisk = Y2022Q2_FVAtRisk) %>%
  mutate(Y2022Q3_AtRisk = Y2022Q3_FVAtRisk)

Q22022_Booster_Only <- CombinedCohorts_Trimmed %>%
  mutate(Q22022_FV_SurvivalTime) %>%
  mutate(Q22022_Booster_SurvivalTime) %>%
  mutate(Q22022_Booster2_SurvivalTime) %>%
  filter(Q22022_Booster_SurvivalTime > 0) %>%
  mutate(SurvivalTime_Infection = Q22022_Booster_SurvivalTime) %>%
  mutate(Infection_InPeriod = PosDuringBoost) %>%
  mutate(Hosp_InPeriod = HosDuringBoost) %>%
  mutate(Death_InPeriod = DeathDuringBoost) %>%
  mutate(Severe_InPeriod = SevereDuringBoost) %>%
  mutate(Booster = 1) %>%
  mutate(Booster2 = 0) %>%
  mutate(YearQuarter_LastVaccination = YearQuarter_Booster) %>%
  # Quarters at risk variables
  mutate(Y2022Q2_AtRisk = Y2022Q2_BoosterAtRisk) %>%
  mutate(Y2022Q3_AtRisk = Y2022Q3_BoosterAtRisk)

Q22022_Booster2_Only <- CombinedCohorts_Trimmed %>%
  mutate(Q22022_FV_SurvivalTime) %>%
  mutate(Q22022_Booster_SurvivalTime) %>%
  mutate(Q22022_Booster2_SurvivalTime) %>%
  filter(Q22022_Booster2_SurvivalTime > 0) %>%
  mutate(SurvivalTime_Infection = Q22022_Booster2_SurvivalTime) %>%
  mutate(Infection_InPeriod = PosDuringBoost2) %>%
  mutate(Hosp_InPeriod = HosDuringBoost2) %>%
  mutate(Death_InPeriod = DeathDuringBoost2) %>%
  mutate(Severe_InPeriod = SevereDuringBoost2) %>%
  mutate(Booster = 1) %>%
  mutate(Booster2 = 1) %>%
  mutate(YearQuarter_LastVaccination = YearQuarter_Booster2) %>%
  # Quarters at risk variables
  mutate(Y2022Q2_AtRisk = Y2022Q2_Booster2AtRisk) %>%
  mutate(Y2022Q3_AtRisk = Y2022Q3_Booster2AtRisk)

Q22022_Cohort_Regression <- rbind.data.frame(Q22022_FV_Only, Q22022_Booster_Only) %>%
  filter(!is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(index))

#%>%
  # Only Primary Care at MM and No Uncertain Diagnosis Data
  #filter(PrimaryCareMM_YN == "Yes") %>%
  #filter(UncertainDiagnosisData != 1 | is.na(UncertainDiagnosisData))
```

```{r}
# Using since quarter instead of in quarter for booster
Q22022_FV_Only2 <- CombinedCohorts_Trimmed %>%
  mutate(Q22022_FV_SurvivalTime) %>%
  mutate(Q22022_Booster_SurvivalTime2) %>%
  mutate(Q22022_Booster2_SurvivalTime2) %>%
  filter(Q22022_FV_SurvivalTime > 0) %>%
  mutate(SurvivalTime_Infection = Q22022_FV_SurvivalTime) %>%
  mutate(Infection_InPeriod = PosDuringFV) %>%
  mutate(Hosp_InPeriod = HosDuringFV) %>%
  mutate(Death_InPeriod = DeathDuringFV) %>%
  mutate(Severe_InPeriod = SevereDuringFV) %>%
  mutate(Booster = 0) %>%
  mutate(Booster2 = 0) %>%
  mutate(YearQuarter_LastVaccination = YearQuarter_FV) %>%
  # Quarters at risk variables
  mutate(Y2022Q2_AtRisk = Y2022Q2_FVAtRisk) %>%
  mutate(Y2022Q3_AtRisk = Y2022Q3_FVAtRisk)

Q22022_Booster_Only2 <- CombinedCohorts_Trimmed %>%
  mutate(Q22022_FV_SurvivalTime) %>%
  mutate(Q22022_Booster_SurvivalTime2) %>%
  mutate(Q22022_Booster2_SurvivalTime2) %>%
  filter(Q22022_Booster_SurvivalTime2 > 0) %>%
  mutate(SurvivalTime_Infection = Q22022_Booster_SurvivalTime2) %>%
  mutate(Infection_InPeriod = PosDuringBoost) %>%
  mutate(Hosp_InPeriod = HosDuringBoost) %>%
  mutate(Death_InPeriod = DeathDuringBoost) %>%
  mutate(Severe_InPeriod = SevereDuringBoost) %>%
  mutate(Booster = 1) %>%
  mutate(Booster2 = 0) %>%
  mutate(YearQuarter_LastVaccination = YearQuarter_Booster) %>%
  # Quarters at risk variables
  mutate(Y2022Q2_AtRisk = Y2022Q2_BoosterAtRisk) %>%
  mutate(Y2022Q3_AtRisk = Y2022Q3_BoosterAtRisk)

Q22022_Booster2_Only2 <- CombinedCohorts_Trimmed %>%
  mutate(Q22022_FV_SurvivalTime) %>%
  mutate(Q22022_Booster_SurvivalTime2) %>%
  mutate(Q22022_Booster2_SurvivalTime2) %>%
  filter(Q22022_Booster2_SurvivalTime2 > 0) %>%
  mutate(SurvivalTime_Infection = Q22022_Booster2_SurvivalTime2) %>%
  mutate(Infection_InPeriod = PosDuringBoost2) %>%
  mutate(Hosp_InPeriod = HosDuringBoost2) %>%
  mutate(Death_InPeriod = DeathDuringBoost2) %>%
  mutate(Severe_InPeriod = SevereDuringBoost2) %>%
  mutate(Booster = 1) %>%
  mutate(Booster2 = 1) %>%
  mutate(YearQuarter_LastVaccination = YearQuarter_Booster2) %>%
  # Quarters at risk variables
  mutate(Y2022Q2_AtRisk = Y2022Q2_Booster2AtRisk) %>%
  mutate(Y2022Q3_AtRisk = Y2022Q3_Booster2AtRisk)

Q22022_Cohort_Regression2 <- rbind.data.frame(Q22022_FV_Only2, Q22022_Booster_Only2) %>%
  filter(!is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(index))

Q22022_Booster2_Cohort_Regression <- rbind.data.frame(select(Q22022_Booster_Only2, -c(Q22022_Booster_SurvivalTime2, Q22022_Booster2_SurvivalTime2)), 
                                                      select(Q22022_Booster2_Only, -c(Q22022_Booster_SurvivalTime, Q22022_Booster2_SurvivalTime))) %>%
  filter(!is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(index)) #%>%
  #filter(Age >= 50) %>%
  #filter(is.na(Relative_First_OralAntivirals) | Relative_First_OralAntivirals > 30) %>%
  #filter(is.na(Relative_First_mAB) | Relative_First_mAB > 30)

Q22022_Booster2_Cohort_Regression2 <- rbind.data.frame(Q22022_Booster_Only2, Q22022_Booster2_Only2) %>%
  filter(!is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(index)) #%>%
  #filter(Age >= 50) %>%
  #filter(is.na(Relative_First_OralAntivirals) | Relative_First_OralAntivirals > 30) %>%
  #filter(is.na(Relative_First_mAB) | Relative_First_mAB > 30)

#%>%
  # Only Primary Care at MM and No Uncertain Diagnosis Data
  #filter(PrimaryCareMM_YN == "Yes") %>%
  #filter(UncertainDiagnosisData != 1 | is.na(UncertainDiagnosisData))
```

### Q3 2022

```{r}
# Q3 2022
# YearQuarter_Immune 8
Q32022_FV_SurvivalTime <- FV_SurvivalTime_Since_Quarter(Quarter = 8, Days_QuartertoPull = 62 + DayAdj)
Q32022_Booster_SurvivalTime <- Booster_SurvivalTime_From_Quarter(Quarter = 8, Days_QuartertoPull = 62 + DayAdj)
Q32022_Booster_SurvivalTime2 <- Booster_SurvivalTime_Since_Quarter(Quarter = 8, Days_QuartertoPull = 62 + DayAdj)

Q32022_Booster2_SurvivalTime <- SecondBooster_SurvivalTime_From_Quarter(Quarter = 8, Days_QuartertoPull = 62 + DayAdj)
Q32022_Booster2_SurvivalTime2 <- SecondBooster_SurvivalTime_Since_Quarter(Quarter = 8, Days_QuartertoPull = 62 + DayAdj)
```

```{r}
Q32022_FV_Only <- CombinedCohorts_Trimmed %>%
  mutate(Q32022_FV_SurvivalTime) %>%
  mutate(Q32022_Booster_SurvivalTime) %>%
  mutate(Q32022_Booster2_SurvivalTime) %>%
  filter(Q32022_FV_SurvivalTime > 0) %>%
  mutate(SurvivalTime_Infection = Q32022_FV_SurvivalTime) %>%
  mutate(Infection_InPeriod = PosDuringFV) %>%
  mutate(Hosp_InPeriod = HosDuringFV) %>%
  mutate(Death_InPeriod = DeathDuringFV) %>%
  mutate(Severe_InPeriod = SevereDuringFV) %>%
  mutate(Booster = 0) %>%
  mutate(Booster2 = 0) %>%
  mutate(YearQuarter_LastVaccination = YearQuarter_FV) %>%
  # Quarters at risk variables
  mutate(Y2022Q3_AtRisk = Y2022Q3_FVAtRisk)

Q32022_Booster_Only <- CombinedCohorts_Trimmed %>%
  mutate(Q32022_FV_SurvivalTime) %>%
  mutate(Q32022_Booster_SurvivalTime) %>%
  mutate(Q32022_Booster2_SurvivalTime) %>%
  filter(Q32022_Booster_SurvivalTime > 0) %>%
  mutate(SurvivalTime_Infection = Q32022_Booster_SurvivalTime) %>%
  mutate(Infection_InPeriod = PosDuringBoost) %>%
  mutate(Hosp_InPeriod = HosDuringBoost) %>%
  mutate(Death_InPeriod = DeathDuringBoost) %>%
  mutate(Severe_InPeriod = SevereDuringBoost) %>%
  mutate(Booster = 1) %>%
  mutate(Booster2 = 0) %>%
  mutate(YearQuarter_LastVaccination = YearQuarter_Booster) %>%
  # Quarters at risk variables
  mutate(Y2022Q3_AtRisk = Y2022Q3_BoosterAtRisk)

Q32022_Booster2_Only <- CombinedCohorts_Trimmed %>%
  mutate(Q32022_FV_SurvivalTime) %>%
  mutate(Q32022_Booster_SurvivalTime) %>%
  mutate(Q32022_Booster2_SurvivalTime) %>%
  filter(Q32022_Booster2_SurvivalTime > 0) %>%
  mutate(SurvivalTime_Infection = Q32022_Booster2_SurvivalTime) %>%
  mutate(Infection_InPeriod = PosDuringBoost2) %>%
  mutate(Hosp_InPeriod = HosDuringBoost2) %>%
  mutate(Death_InPeriod = DeathDuringBoost2) %>%
  mutate(Severe_InPeriod = SevereDuringBoost2) %>%
  mutate(Booster = 1) %>%
  mutate(Booster2 = 1) %>%
  mutate(YearQuarter_LastVaccination = YearQuarter_Booster2) %>%
  # Quarters at risk variables
  mutate(Y2022Q3_AtRisk = Y2022Q3_Booster2AtRisk)

Q32022_Cohort_Regression <- rbind.data.frame(Q32022_FV_Only, Q32022_Booster_Only) %>%
  filter(!is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(index))

# DEPRECIATED
# does not include boosted before Q3
#Q32022_Booster2_Cohort_Regression <- rbind.data.frame(Q32022_Booster_Only, Q32022_Booster2_Only) %>%
#  filter(!is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(index)) %>%
#  filter(Age >= 50) %>%
#  filter(is.na(Relative_First_OralAntivirals) | Relative_First_OralAntivirals > 30) %>%
#  filter(is.na(Relative_First_mAB) | Relative_First_mAB > 30)

#%>%
  # Only Primary Care at MM and No Uncertain Diagnosis Data
  #filter(PrimaryCareMM_YN == "Yes") %>%
  #filter(UncertainDiagnosisData != 1 | is.na(UncertainDiagnosisData))
```

```{r}
# Using since quarter instead of in quarter for booster
Q32022_FV_Only2 <- CombinedCohorts_Trimmed %>%
  mutate(Q32022_FV_SurvivalTime) %>%
  mutate(Q32022_Booster_SurvivalTime2) %>%
  mutate(Q32022_Booster2_SurvivalTime2) %>%
  filter(Q32022_FV_SurvivalTime > 0) %>%
  mutate(SurvivalTime_Infection = Q32022_FV_SurvivalTime) %>%
  mutate(Infection_InPeriod = PosDuringFV) %>%
  mutate(Hosp_InPeriod = HosDuringFV) %>%
  mutate(Death_InPeriod = DeathDuringFV) %>%
  mutate(Severe_InPeriod = SevereDuringFV) %>%
  mutate(Booster = 0) %>%
  mutate(Booster2 = 0) %>%
  mutate(YearQuarter_LastVaccination = YearQuarter_FV) %>%
  # Quarters at risk variables
  mutate(Y2022Q3_AtRisk = Y2022Q3_FVAtRisk)

Q32022_Booster_Only2 <- CombinedCohorts_Trimmed %>%
  mutate(Q32022_FV_SurvivalTime) %>%
  mutate(Q32022_Booster_SurvivalTime2) %>%
  mutate(Q32022_Booster2_SurvivalTime2) %>%
  filter(Q32022_Booster_SurvivalTime2 > 0) %>%
  mutate(SurvivalTime_Infection = Q32022_Booster_SurvivalTime2) %>%
  mutate(Infection_InPeriod = PosDuringBoost) %>%
  mutate(Hosp_InPeriod = HosDuringBoost) %>%
  mutate(Death_InPeriod = DeathDuringBoost) %>%
  mutate(Severe_InPeriod = SevereDuringBoost) %>%
  mutate(Booster = 1) %>%
  mutate(Booster2 = 0) %>%
  mutate(YearQuarter_LastVaccination = YearQuarter_Booster) %>%
  # Quarters at risk variables
  mutate(Y2022Q3_AtRisk = Y2022Q3_BoosterAtRisk)

Q32022_Booster2_Only2 <- CombinedCohorts_Trimmed %>%
  mutate(Q32022_FV_SurvivalTime) %>%
  mutate(Q32022_Booster_SurvivalTime2) %>%
  mutate(Q32022_Booster2_SurvivalTime2) %>%
  filter(Q32022_Booster2_SurvivalTime2 > 0) %>%
  mutate(SurvivalTime_Infection = Q32022_Booster2_SurvivalTime2) %>%
  mutate(Infection_InPeriod = PosDuringBoost2) %>%
  mutate(Hosp_InPeriod = HosDuringBoost2) %>%
  mutate(Death_InPeriod = DeathDuringBoost2) %>%
  mutate(Severe_InPeriod = SevereDuringBoost2) %>%
  mutate(Booster = 1) %>%
  mutate(Booster2 = 1) %>%
  mutate(YearQuarter_LastVaccination = YearQuarter_Booster2) %>%
  # Quarters at risk variables
  mutate(Y2022Q3_AtRisk = Y2022Q3_Booster2AtRisk)

Q32022_Cohort_Regression2 <- rbind.data.frame(Q32022_FV_Only2, Q32022_Booster_Only2) %>%
  filter(!is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(index))

Q32022_Booster2_Cohort_Regression <- rbind.data.frame(select(Q32022_Booster_Only2, -c(Q32022_Booster_SurvivalTime2, Q32022_Booster2_SurvivalTime2)), 
                                                      select(Q32022_Booster2_Only, -c(Q32022_Booster_SurvivalTime, Q32022_Booster2_SurvivalTime))) %>%
  filter(!is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(index)) #%>%
  #filter(Age >= 50) %>%
  #filter(is.na(Relative_First_OralAntivirals) | Relative_First_OralAntivirals > 30) %>%
  #filter(is.na(Relative_First_mAB) | Relative_First_mAB > 30)

Q32022_Booster2_Cohort_Regression2 <- rbind.data.frame(Q32022_Booster_Only2, Q32022_Booster2_Only2) %>%
  filter(!is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(index)) #%>%
  #filter(Age >= 50) %>%
  #filter(is.na(Relative_First_OralAntivirals) | Relative_First_OralAntivirals > 30) %>%
  #filter(is.na(Relative_First_mAB) | Relative_First_mAB > 30)

#%>%
  # Only Primary Care at MM and No Uncertain Diagnosis Data
  #filter(PrimaryCareMM_YN == "Yes") %>%
  #filter(UncertainDiagnosisData != 1 | is.na(UncertainDiagnosisData))
```

# Table 1

```{r}
CombinedCohorts_Trimmed_CC <- CombinedCohorts_Trimmed %>%
  mutate(negativeTests2 = case_when(!is.na(negativeTests) ~ negativeTests,
                                    TRUE ~ integer(1))) %>%
  filter(!is.na(AgeCategory) & !is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(popden13_17_qrtl) & !is.na(index)) %>%
  filter(AgeCategory != "[0,18)")
```

## Main Analysis

```{r}
Q42021_Cohort_Regression <- Q42021_Cohort_Regression %>%
  mutate(negativeTests2 = case_when(!is.na(negativeTests) ~ negativeTests,
                                    TRUE ~ integer(1)))
```

```{r}
table1(~ Age + AgeCategory + Sex + BMI + BMI_category + RaceEthnicity4 + as.factor(disadvantage2_13_17_qrtl) + as.factor(popden13_17_qrtl) + HCW + score + index + as.factor(PrimaryCareMM_Ind) + negativeTests2 + negativeTests_Cat | Booster,
       data = Q42021_Cohort_Regression)
```

```{r}
table(Q42021_Cohort_Regression$Booster, Q42021_Cohort_Regression$Infection_InPeriod)
prop.table(table(Q42021_Cohort_Regression$Booster, Q42021_Cohort_Regression$Infection_InPeriod), margin = 1)
```

```{r}
table(Q42021_Cohort_Regression$Booster, Q42021_Cohort_Regression$Severe_InPeriod)
prop.table(table(Q42021_Cohort_Regression$Booster, Q42021_Cohort_Regression$Severe_InPeriod), margin = 1)
```

```{r}
table(Q42021_Cohort_Regression$Infection_InPeriod, Q42021_Cohort_Regression$Severe_InPeriod)
prop.table(table(Q42021_Cohort_Regression$Infection_InPeriod, Q42021_Cohort_Regression$Severe_InPeriod), margin = 1)
```


## Overall Cohort

```{r}
table1(~ Age + AgeCategory + Sex + BMI + BMI_category + RaceEthnicity4 + as.factor(disadvantage2_13_17_qrtl) + as.factor(popden13_17_qrtl) + HCW + score + index + as.factor(PrimaryCareMM_Ind) + negativeTests2 + negativeTests_Cat,
       data = filter(CombinedCohorts_Trimmed_CC, FVTime_Ind == 1 | BoostTime_Ind == 1 | Boost2Time_Ind == 1))

table1(~ Age + AgeCategory + Sex + BMI + BMI_category + RaceEthnicity4 + as.factor(disadvantage2_13_17_qrtl) + as.factor(popden13_17_qrtl) + HCW + score + index + as.factor(PrimaryCareMM_Ind) + negativeTests2 + negativeTests_Cat,
       data = filter(CombinedCohorts_Trimmed_CC, FVTime_Ind == 1))

table1(~ Age + AgeCategory + Sex + BMI + BMI_category + RaceEthnicity4 + as.factor(disadvantage2_13_17_qrtl) + as.factor(popden13_17_qrtl) + HCW + score + index + as.factor(PrimaryCareMM_Ind) + negativeTests2 + negativeTests_Cat,
       data = filter(CombinedCohorts_Trimmed_CC, BoostTime_Ind == 1))

table1(~ Age + AgeCategory + Sex + BMI + BMI_category + RaceEthnicity4 + as.factor(disadvantage2_13_17_qrtl) + as.factor(popden13_17_qrtl) + HCW + score + index + as.factor(PrimaryCareMM_Ind) + negativeTests2 + negativeTests_Cat,
       data = filter(CombinedCohorts_Trimmed_CC, Boost2Time_Ind == 1))
```

## Second Booster

```{r}
Q22022_Booster2_Cohort_Regression <- Q22022_Booster2_Cohort_Regression %>%
  mutate(negativeTests2 = case_when(!is.na(negativeTests) ~ negativeTests,
                                    TRUE ~ integer(1)))
```

```{r}
table1(~ Age + AgeCategory + Sex + BMI + BMI_category + RaceEthnicity4 + as.factor(disadvantage2_13_17_qrtl) + as.factor(popden13_17_qrtl) + HCW + score + index + as.factor(PrimaryCareMM_Ind) + negativeTests2 + negativeTests_Cat | Booster2,
       data = Q22022_Booster2_Cohort_Regression)
```

# VE Analysis

## Result Extraction Function

```{r}
mod_extraction <- function(mod){
  n <- mod$n
  summary <- summary(mod)
  VE <- 1 - summary$conf.int[1,"exp(coef)"]
  Lower95 <- 1 - summary$conf.int[1, "upper .95"]
  Upper95 <- 1 - summary$conf.int[1, "lower .95"]
  res <- c(n, VE, Lower95, Upper95)
  return(res)
}
```


## Unstratified Models

```{r, eval = FALSE}
# Dataframes with only FV and Booster
FV_Only <- CombinedCohorts_Trimmed %>%
  filter(FV_SurvivalTime_Infection > 0) %>%
  mutate(SurvivalTime_Infection = FV_SurvivalTime_Infection) %>%
  mutate(Infection_InPeriod = PosDuringFV) %>%
  mutate(Hosp_InPeriod = HosDuringFV) %>%
  mutate(Death_InPeriod = DeathDuringFV) %>%
  mutate(Severe_InPeriod = SevereDuringFV) %>%
  mutate(Booster = 0) %>%
  mutate(YearQuarter_LastVaccination = YearQuarter_FV) %>%
  # Quarters at risk variables
  mutate(Y2020Q4_AtRisk = Y2020Q4_FVAtRisk) %>%
  mutate(Y2021Q1_AtRisk = Y2021Q1_FVAtRisk) %>%
  mutate(Y2021Q2_AtRisk = Y2021Q2_FVAtRisk) %>%
  mutate(Y2021Q3_AtRisk = Y2021Q3_FVAtRisk) %>%
  mutate(Y2021Q4_AtRisk = Y2021Q4_FVAtRisk) %>%
  mutate(Y2022Q1_AtRisk = Y2022Q1_FVAtRisk) %>%
  mutate(Y2022Q2_AtRisk = Y2022Q2_FVAtRisk) %>%
  mutate(Y2022Q3_AtRisk = Y2022Q3_FVAtRisk) 

Booster_Only <- CombinedCohorts_Trimmed %>%
  filter(Booster_SurvivalTime_Infection > 0) %>%
  mutate(SurvivalTime_Infection = Booster_SurvivalTime_Infection) %>%
  mutate(Infection_InPeriod = PosDuringBoost) %>%
  mutate(Hosp_InPeriod = HosDuringBoost) %>%
  mutate(Death_InPeriod = DeathDuringBoost) %>%
  mutate(Severe_InPeriod = SevereDuringBoost) %>%
  mutate(Booster = 1) %>%
  mutate(YearQuarter_LastVaccination = YearQuarter_Booster) %>%
  # Quarters at risk variables
  mutate(Y2020Q4_AtRisk = as.factor(0)) %>%
  mutate(Y2021Q1_AtRisk = as.factor(0)) %>%
  mutate(Y2021Q2_AtRisk = as.factor(0)) %>%
  mutate(Y2021Q3_AtRisk = as.factor(0)) %>%
  mutate(Y2021Q4_AtRisk = Y2021Q4_BoosterAtRisk) %>%
  mutate(Y2022Q1_AtRisk = Y2022Q1_BoosterAtRisk) %>%
  mutate(Y2022Q2_AtRisk = Y2022Q2_BoosterAtRisk) %>%
  mutate(Y2022Q3_AtRisk = Y2022Q3_BoosterAtRisk) 

Cohort_Regression <- rbind.data.frame(FV_Only, Booster_Only) %>%
  filter(!is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(index))
```

### Infection

```{r, eval = FALSE}
# Unadjusted Infection Model
cohort_infection_mod_unadj <- coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster, data = Cohort_Regression)
summary(cohort_infection_mod_unadj)
ggsurvplot(survfit(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster, data = Cohort_Regression),
           conf.int = TRUE,
           fun = "cumhaz")
```

```{r, eval = FALSE}
# Adjusted Infection Model
summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Cohort_Regression))
```

### Hospitalization

```{r, eval = FALSE}
# Unadjusted Hospitalization Model
summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster, data = Cohort_Regression))
ggsurvplot(survfit(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster, data = Cohort_Regression),
           conf.int = TRUE,
           fun = "cumhaz")
```

```{r, eval = FALSE}
# Adjusted Hospitalization Model
summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Cohort_Regression))
```

### Death

```{r, eval = FALSE}
# Unadjusted Death Model
summary(coxph(Surv(time = SurvivalTime_Infection, event = Death_InPeriod) ~ Booster, data = Cohort_Regression))
ggsurvplot(survfit(Surv(time = SurvivalTime_Infection, event = Death_InPeriod) ~ Booster, data = Cohort_Regression),
           conf.int = TRUE,
           fun = "cumhaz")
```

```{r, eval = FALSE}
# Adjusted Death Model
coxph(Surv(time = SurvivalTime_Infection, event = Death_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Cohort_Regression)
```

# Boosted At Quarter Models

## Q4 2021

```{r}
Q42021_tab_infection <- table(Q42021_Cohort_Regression$Booster, Q42021_Cohort_Regression$Infection_InPeriod)
Q42021_tab_infection
Q42021_tab_infection[2,2] * Q42021_tab_infection[1,1] / (Q42021_tab_infection[1,2] * Q42021_tab_infection[2,1])
Q42021_tab_hospitalization <- table(Q42021_Cohort_Regression$Booster, Q42021_Cohort_Regression$Hosp_InPeriod)
Q42021_tab_hospitalization
Q42021_tab_hospitalization[2,2] * Q42021_tab_hospitalization[1,1] / (Q42021_tab_hospitalization[1,2] * Q42021_tab_hospitalization[2,1])
```

```{r}
# Unadjusted Infection Model
summary(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster, data = filter(Q42021_Cohort_Regression, !is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(index))))
1 - summary(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster, data = filter(Q42021_Cohort_Regression, !is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(index))))$conf.int
```

```{r}
ggsurvplot(survfit(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster, data = filter(Q42021_Cohort_Regression, !is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(index))),
           conf.int = TRUE,
           fun = "cumhaz")
```

```{r}
# Adjusted Infection Model
mod_extraction(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q42021_Cohort_Regression))
summary(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q42021_Cohort_Regression))
1 - summary(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q42021_Cohort_Regression))$conf.int
```

```{r}
# Unadjusted Hospitalization Model
summary(coxph(Surv(SurvivalTime_Infection, Hosp_InPeriod) ~ Booster, data = filter(Q42021_Cohort_Regression, !is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(index))))
1 - summary(coxph(Surv(SurvivalTime_Infection, Hosp_InPeriod) ~ Booster, data = filter(Q42021_Cohort_Regression, !is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(index))))$conf.int
```

```{r}
ggsurvplot(survfit(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster, data = filter(Q42021_Cohort_Regression, !is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(index))),
           conf.int = TRUE,
           fun = "cumhaz")
```

```{r}
# Adjusted Hospitalization Model
summary(coxph(Surv(SurvivalTime_Infection, Hosp_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q42021_Cohort_Regression))
1 - summary(coxph(Surv(SurvivalTime_Infection, Hosp_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q42021_Cohort_Regression))$conf.int
```

```{r}
# Unadjusted Death Model
summary(coxph(Surv(SurvivalTime_Infection, Death_InPeriod) ~ Booster, data = filter(Q42021_Cohort_Regression, !is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(index))))
```

```{r}
ggsurvplot(survfit(Surv(time = SurvivalTime_Infection, event = Death_InPeriod) ~ Booster, data = filter(Q42021_Cohort_Regression, !is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(index))),
           conf.int = TRUE,
           fun = "cumhaz")
```

```{r}
# Adjusted Death Model
summary(coxph(Surv(SurvivalTime_Infection, Death_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q42021_Cohort_Regression))
```

```{r}
# Unadjusted Severe Disease Model
summary(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster, data = filter(Q42021_Cohort_Regression, !is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(index))))
1 - summary(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster, data = filter(Q42021_Cohort_Regression, !is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(index))))$conf.int
```

```{r}
ggsurvplot(survfit(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster, data = filter(Q42021_Cohort_Regression, !is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(index))),
           conf.int = TRUE,
           fun = "cumhaz")
```

```{r}
# Adjusted Severe Disease Model
summary(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q42021_Cohort_Regression))
1 - summary(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q42021_Cohort_Regression))$conf.int
```

## Q1 2022

```{r}
Q12022_tab_infection <- table(Q12022_Cohort_Regression$Booster, Q12022_Cohort_Regression$Infection_InPeriod)
Q12022_tab_infection
Q12022_tab_infection[2,2] * Q12022_tab_infection[1,1] / (Q12022_tab_infection[1,2] * Q12022_tab_infection[2,1])
Q12022_tab_hospitalization <- table(Q12022_Cohort_Regression$Booster, Q12022_Cohort_Regression$Hosp_InPeriod)
Q12022_tab_hospitalization
Q12022_tab_hospitalization[2,2] * Q12022_tab_hospitalization[1,1] / (Q12022_tab_hospitalization[1,2] * Q12022_tab_hospitalization[2,1])
```

```{r}
# Unadjusted Infection Model
summary(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster, data = filter(Q12022_Cohort_Regression, !is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(index))))
1 - summary(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster, data = filter(Q12022_Cohort_Regression, !is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(index))))$conf.int
```

```{r}
ggsurvplot(survfit(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster, data = filter(Q12022_Cohort_Regression, !is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(index))),
           conf.int = TRUE,
           fun = "cumhaz")
```

```{r}
# Adjusted Infection Model
summary(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q12022_Cohort_Regression))
1 - summary(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q12022_Cohort_Regression))$conf.int
```

```{r}
# Unadjusted Hospitalization Model
summary(coxph(Surv(SurvivalTime_Infection, Hosp_InPeriod) ~ Booster, data = filter(Q12022_Cohort_Regression, !is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(index))))
1 - summary(coxph(Surv(SurvivalTime_Infection, Hosp_InPeriod) ~ Booster, data = filter(Q12022_Cohort_Regression, !is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(index))))$conf.int
```

```{r}
ggsurvplot(survfit(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster, data = filter(Q12022_Cohort_Regression, !is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(index))),
           conf.int = TRUE,
           fun = "cumhaz")
```

```{r}
# Adjusted Hospitalization Model
summary(coxph(Surv(SurvivalTime_Infection, Hosp_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q12022_Cohort_Regression))
1 - summary(coxph(Surv(SurvivalTime_Infection, Hosp_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q12022_Cohort_Regression))$conf.int
```

```{r}
# Unadjusted Death Model
summary(coxph(Surv(SurvivalTime_Infection, Death_InPeriod) ~ Booster, data = filter(Q12022_Cohort_Regression, !is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(index))))
```

```{r}
ggsurvplot(survfit(Surv(time = SurvivalTime_Infection, event = Death_InPeriod) ~ Booster, data = filter(Q12022_Cohort_Regression, !is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(index))),
           conf.int = TRUE,
           fun = "cumhaz")
```

```{r}
# Adjusted Death Model
summary(coxph(Surv(SurvivalTime_Infection, Death_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q12022_Cohort_Regression))
```

## Q2 2022

```{r}
Q22022_tab_infection <- table(Q22022_Cohort_Regression$Booster, Q22022_Cohort_Regression$Infection_InPeriod)
Q22022_tab_infection
Q22022_tab_infection[2,2] * Q22022_tab_infection[1,1] / (Q22022_tab_infection[1,2] * Q22022_tab_infection[2,1])
Q22022_tab_hospitalization <- table(Q22022_Cohort_Regression$Booster, Q22022_Cohort_Regression$Hosp_InPeriod)
Q22022_tab_hospitalization
Q22022_tab_hospitalization[2,2] * Q22022_tab_hospitalization[1,1] / (Q22022_tab_hospitalization[1,2] * Q22022_tab_hospitalization[2,1])
```

```{r}
# Unadjusted Infection Model
summary(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster, data = filter(Q22022_Cohort_Regression, !is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(index))))
1 - summary(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster, data = filter(Q22022_Cohort_Regression, !is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(index))))$conf.int
```

```{r}
ggsurvplot(survfit(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster, data = filter(Q22022_Cohort_Regression, !is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(index))),
           conf.int = TRUE,
           fun = "cumhaz")
```

```{r}
# Adjusted Infection Model
summary(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q22022_Cohort_Regression))
1 - summary(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q22022_Cohort_Regression))$conf.int
```

```{r}
# Unadjusted Hospitalization Model
summary(coxph(Surv(SurvivalTime_Infection, Hosp_InPeriod) ~ Booster, data = filter(Q22022_Cohort_Regression, !is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(index))))
1 - summary(coxph(Surv(SurvivalTime_Infection, Hosp_InPeriod) ~ Booster, data = filter(Q22022_Cohort_Regression, !is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(index))))$conf.int
```

```{r}
ggsurvplot(survfit(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster, data = filter(Q22022_Cohort_Regression, !is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(index))),
           conf.int = TRUE,
           fun = "cumhaz")
```

```{r}
# Adjusted Hospitalization Model
summary(coxph(Surv(SurvivalTime_Infection, Hosp_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q22022_Cohort_Regression))
1 - summary(coxph(Surv(SurvivalTime_Infection, Hosp_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q22022_Cohort_Regression))$conf.int
```

```{r}
# Unadjusted Death Model
summary(coxph(Surv(SurvivalTime_Infection, Death_InPeriod) ~ Booster, data = filter(Q22022_Cohort_Regression, !is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(index))))
```

```{r}
ggsurvplot(survfit(Surv(time = SurvivalTime_Infection, event = Death_InPeriod) ~ Booster, data = filter(Q22022_Cohort_Regression, !is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(index))),
           conf.int = TRUE,
           fun = "cumhaz")
```

```{r}
# Adjusted Death Model
summary(coxph(Surv(SurvivalTime_Infection, Death_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q22022_Cohort_Regression))
```

## Q3 2022

```{r}
Q32022_tab_infection <- table(Q32022_Cohort_Regression$Booster, Q32022_Cohort_Regression$Infection_InPeriod)
Q32022_tab_infection
Q32022_tab_infection[2,2] * Q32022_tab_infection[1,1] / (Q32022_tab_infection[1,2] * Q32022_tab_infection[2,1])
Q32022_tab_hospitalization <- table(Q32022_Cohort_Regression$Booster, Q32022_Cohort_Regression$Hosp_InPeriod)
Q32022_tab_hospitalization
Q32022_tab_hospitalization[2,2] * Q32022_tab_hospitalization[1,1] / (Q32022_tab_hospitalization[1,2] * Q32022_tab_hospitalization[2,1])
```

```{r}
# Unadjusted Infection Model
summary(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster, data = filter(Q32022_Cohort_Regression, !is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(index))))
1 - summary(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster, data = filter(Q32022_Cohort_Regression, !is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(index))))$conf.int
```

```{r}
ggsurvplot(survfit(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster, data = filter(Q32022_Cohort_Regression, !is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(index))),
           conf.int = TRUE,
           fun = "cumhaz")
```

```{r}
# Adjusted Infection Model
summary(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q32022_Cohort_Regression))
1 - summary(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q32022_Cohort_Regression))$conf.int
```

```{r}
# Unadjusted Hospitalization Model
summary(coxph(Surv(SurvivalTime_Infection, Hosp_InPeriod) ~ Booster, data = filter(Q32022_Cohort_Regression, !is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(index))))
1 - summary(coxph(Surv(SurvivalTime_Infection, Hosp_InPeriod) ~ Booster, data = filter(Q32022_Cohort_Regression, !is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(index))))$conf.int
```

```{r}
ggsurvplot(survfit(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster, data = filter(Q32022_Cohort_Regression, !is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(index))),
           conf.int = TRUE,
           fun = "cumhaz")
```

```{r}
# Adjusted Hospitalization Model
summary(coxph(Surv(SurvivalTime_Infection, Hosp_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q32022_Cohort_Regression))
1 - summary(coxph(Surv(SurvivalTime_Infection, Hosp_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q32022_Cohort_Regression))$conf.int
```

```{r}
# Unadjusted Death Model
summary(coxph(Surv(SurvivalTime_Infection, Death_InPeriod) ~ Booster, data = filter(Q32022_Cohort_Regression, !is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(index))))
```

```{r}
ggsurvplot(survfit(Surv(time = SurvivalTime_Infection, event = Death_InPeriod) ~ Booster, data = filter(Q32022_Cohort_Regression, !is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(index))),
           conf.int = TRUE,
           fun = "cumhaz")
```

```{r}
# Adjusted Death Model
summary(coxph(Surv(SurvivalTime_Infection, Death_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q32022_Cohort_Regression))
```

# Boosted Since Quarter Models

## Q4 2021

```{r}
Q42021_tab_infection <- table(Q42021_Cohort_Regression2$Booster, Q42021_Cohort_Regression2$Infection_InPeriod)
Q42021_tab_infection
Q42021_tab_infection[2,2] * Q42021_tab_infection[1,1] / (Q42021_tab_infection[1,2] * Q42021_tab_infection[2,1])
Q42021_tab_hospitalization <- table(Q42021_Cohort_Regression2$Booster, Q42021_Cohort_Regression2$Hosp_InPeriod)
Q42021_tab_hospitalization
Q42021_tab_hospitalization[2,2] * Q42021_tab_hospitalization[1,1] / (Q42021_tab_hospitalization[1,2] * Q42021_tab_hospitalization[2,1])
```

```{r}
# Unadjusted Infection Model
summary(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster, data = filter(Q42021_Cohort_Regression2, !is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(index))))
1 - summary(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster, data = filter(Q42021_Cohort_Regression2, !is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(index))))$conf.int
```

```{r}
ggsurvplot(survfit(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster, data = Q42021_Cohort_Regression2),
           conf.int = TRUE,
           fun = "cumhaz", 
           ylim = c(0, 0.125))
```

```{r}
ggsurvplot(survfit(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster, data = filter(Q42021_Cohort_Regression2, !is.na(BMI))),
           conf.int = TRUE,
           fun = "cumhaz", 
           ylim = c(0, 0.125))
```

```{r}
# Adjusted Infection Model (without number of negative tests)
summary(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index, data = Q42021_Cohort_Regression2))
```

```{r}
# Adjusted Infection Model Including Number of Negative Tests
summary(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q42021_Cohort_Regression2))
1 - summary(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q42021_Cohort_Regression2))$conf.int
```

```{r}
# Unadjusted Hospitalization Model
summary(coxph(Surv(SurvivalTime_Infection, Hosp_InPeriod) ~ Booster, data = filter(Q42021_Cohort_Regression2, !is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(index))))
1 - summary(coxph(Surv(SurvivalTime_Infection, Hosp_InPeriod) ~ Booster, data = filter(Q42021_Cohort_Regression2, !is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(index))))$conf.int
```

```{r}
ggsurvplot(survfit(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster, data = Q42021_Cohort_Regression2),
           conf.int = TRUE,
           fun = "cumhaz")
```

```{r}
# Adjusted Hospitalization Model (without number of negative tests)
summary(coxph(Surv(SurvivalTime_Infection, Hosp_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind, data = Q42021_Cohort_Regression2))
```

```{r}
# Adjusted Hospitalization Model Adjusting for Number of Negative Tests
summary(coxph(Surv(SurvivalTime_Infection, Hosp_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q42021_Cohort_Regression2))
1 - summary(coxph(Surv(SurvivalTime_Infection, Hosp_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q42021_Cohort_Regression2))$conf.int
```

```{r}
# Unadjusted Death Model
summary(coxph(Surv(SurvivalTime_Infection, Death_InPeriod) ~ Booster, data = filter(Q42021_Cohort_Regression2, !is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(index))))
```

```{r}
ggsurvplot(survfit(Surv(time = SurvivalTime_Infection, event = Death_InPeriod) ~ Booster, data = Q42021_Cohort_Regression2),
           conf.int = TRUE,
           fun = "cumhaz")
```

```{r}
# Adjusted Death Model
summary(coxph(Surv(SurvivalTime_Infection, Death_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q42021_Cohort_Regression2))
```

## Q1 2022

```{r}
Q12022_tab_infection <- table(Q12022_Cohort_Regression2$Booster, Q12022_Cohort_Regression2$Infection_InPeriod)
Q12022_tab_infection
Q12022_tab_infection[2,2] * Q12022_tab_infection[1,1] / (Q12022_tab_infection[1,2] * Q12022_tab_infection[2,1])
Q12022_tab_hospitalization <- table(Q12022_Cohort_Regression2$Booster, Q12022_Cohort_Regression2$Hosp_InPeriod)
Q12022_tab_hospitalization
Q12022_tab_hospitalization[2,2] * Q12022_tab_hospitalization[1,1] / (Q12022_tab_hospitalization[1,2] * Q12022_tab_hospitalization[2,1])
```

```{r}
# Unadjusted Infection Model
summary(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster, data = filter(Q12022_Cohort_Regression2, !is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(index))))
1 - summary(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster, data = filter(Q12022_Cohort_Regression2, !is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(index))))$conf.int
```

```{r}
ggsurvplot(survfit(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster, data = Q12022_Cohort_Regression2),
           conf.int = TRUE,
           fun = "cumhaz")
```

```{r}
# Adjusted Infection Model
summary(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q12022_Cohort_Regression2))
1 - summary(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q12022_Cohort_Regression2))$conf.int
```

```{r}
# Unadjusted Hospitalization Model
summary(coxph(Surv(SurvivalTime_Infection, Hosp_InPeriod) ~ Booster, data = filter(Q12022_Cohort_Regression2, !is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(index))))
1 - summary(coxph(Surv(SurvivalTime_Infection, Hosp_InPeriod) ~ Booster, data = filter(Q12022_Cohort_Regression2, !is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(index))))$conf.int
```

```{r}
ggsurvplot(survfit(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster, data = Q12022_Cohort_Regression2),
           conf.int = TRUE,
           fun = "cumhaz")
```

```{r}
# Adjusted Hospitalization Model
summary(coxph(Surv(SurvivalTime_Infection, Hosp_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q12022_Cohort_Regression2))
1 - summary(coxph(Surv(SurvivalTime_Infection, Hosp_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q12022_Cohort_Regression2))$conf.int
```

```{r}
# Unadjusted Death Model
summary(coxph(Surv(SurvivalTime_Infection, Death_InPeriod) ~ Booster, data = Q12022_Cohort_Regression2))
```

```{r}
ggsurvplot(survfit(Surv(time = SurvivalTime_Infection, event = Death_InPeriod) ~ Booster, data = Q12022_Cohort_Regression2),
           conf.int = TRUE,
           fun = "cumhaz")
```

```{r}
# Adjusted Death Model
summary(coxph(Surv(SurvivalTime_Infection, Death_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q12022_Cohort_Regression2))
```

## Q2 2022

```{r}
Q22022_tab_infection <- table(Q22022_Cohort_Regression2$Booster, Q22022_Cohort_Regression2$Infection_InPeriod)
Q22022_tab_infection
Q22022_tab_infection[2,2] * Q22022_tab_infection[1,1] / (Q22022_tab_infection[1,2] * Q22022_tab_infection[2,1])
Q22022_tab_hospitalization <- table(Q22022_Cohort_Regression2$Booster, Q22022_Cohort_Regression2$Hosp_InPeriod)
Q22022_tab_hospitalization
Q22022_tab_hospitalization[2,2] * Q22022_tab_hospitalization[1,1] / (Q22022_tab_hospitalization[1,2] * Q22022_tab_hospitalization[2,1])
```

```{r}
# Unadjusted Infection Model
summary(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster, data = Q22022_Cohort_Regression2))
1 - summary(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster, data = Q22022_Cohort_Regression2))$conf.int
```

```{r}
ggsurvplot(survfit(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster, data = Q22022_Cohort_Regression2),
           conf.int = TRUE,
           fun = "cumhaz")
```

```{r}
# Adjusted Infection Model
summary(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q22022_Cohort_Regression2))
1 - summary(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q22022_Cohort_Regression2))$conf.int
```

```{r}
# Unadjusted Hospitalization Model
summary(coxph(Surv(SurvivalTime_Infection, Hosp_InPeriod) ~ Booster, data = Q22022_Cohort_Regression2))
1 - summary(coxph(Surv(SurvivalTime_Infection, Hosp_InPeriod) ~ Booster, data = Q22022_Cohort_Regression2))$conf.int
```

```{r}
ggsurvplot(survfit(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster, data = Q22022_Cohort_Regression2),
           conf.int = TRUE,
           fun = "cumhaz")
```

```{r}
# Adjusted Hospitalization Model
summary(coxph(Surv(SurvivalTime_Infection, Hosp_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q22022_Cohort_Regression2))
1 - summary(coxph(Surv(SurvivalTime_Infection, Hosp_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q22022_Cohort_Regression2))$conf.int
```

```{r}
# Unadjusted Death Model
summary(coxph(Surv(SurvivalTime_Infection, Death_InPeriod) ~ Booster, data = Q22022_Cohort_Regression2))
```

```{r}
ggsurvplot(survfit(Surv(time = SurvivalTime_Infection, event = Death_InPeriod) ~ Booster, data = Q22022_Cohort_Regression2),
           conf.int = TRUE,
           fun = "cumhaz")
```

```{r}
# Adjusted Death Model
summary(coxph(Surv(SurvivalTime_Infection, Death_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q22022_Cohort_Regression2))
```

## Q3 2022

```{r}
Q32022_tab_infection <- table(Q32022_Cohort_Regression2$Booster, Q32022_Cohort_Regression2$Infection_InPeriod)
Q32022_tab_infection
Q32022_tab_infection[2,2] * Q32022_tab_infection[1,1] / (Q32022_tab_infection[1,2] * Q32022_tab_infection[2,1])
Q32022_tab_hospitalization <- table(Q32022_Cohort_Regression2$Booster, Q32022_Cohort_Regression2$Hosp_InPeriod)
Q32022_tab_hospitalization
Q32022_tab_hospitalization[2,2] * Q32022_tab_hospitalization[1,1] / (Q32022_tab_hospitalization[1,2] * Q32022_tab_hospitalization[2,1])
```

```{r}
# Unadjusted Infection Model
summary(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster, data = Q32022_Cohort_Regression2))
1 - summary(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster, data = Q32022_Cohort_Regression2))$conf.int
```

```{r}
ggsurvplot(survfit(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster, data = Q32022_Cohort_Regression2),
           conf.int = TRUE,
           fun = "cumhaz")
```

```{r}
# Adjusted Infection Model
summary(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q32022_Cohort_Regression2))
1 - summary(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q32022_Cohort_Regression2))$conf.int
```

```{r}
# Unadjusted Hospitalization Model
summary(coxph(Surv(SurvivalTime_Infection, Hosp_InPeriod) ~ Booster, data = Q32022_Cohort_Regression2))
1 - summary(coxph(Surv(SurvivalTime_Infection, Hosp_InPeriod) ~ Booster, data = Q32022_Cohort_Regression2))$conf.int
```

```{r}
ggsurvplot(survfit(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster, data = Q32022_Cohort_Regression2),
           conf.int = TRUE,
           fun = "cumhaz")
```

```{r}
# Adjusted Hospitalization Model
summary(coxph(Surv(SurvivalTime_Infection, Hosp_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q32022_Cohort_Regression2))
1 - summary(coxph(Surv(SurvivalTime_Infection, Hosp_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q32022_Cohort_Regression2))$conf.int
```

```{r}
# Unadjusted Death Model
summary(coxph(Surv(SurvivalTime_Infection, Death_InPeriod) ~ Booster, data = Q32022_Cohort_Regression2))
```

```{r}
ggsurvplot(survfit(Surv(time = SurvivalTime_Infection, event = Death_InPeriod) ~ Booster, data = Q32022_Cohort_Regression2),
           conf.int = TRUE,
           fun = "cumhaz")
```

```{r}
# Adjusted Death Model
summary(coxph(Surv(SurvivalTime_Infection, Death_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q32022_Cohort_Regression2))
```

# Non-Matched Model Extraction

```{r}
forest_nonmatched_infection <- rbind.data.frame(
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster, data = Q42021_Cohort_Regression)),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q42021_Cohort_Regression)),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster, data = Q42021_Cohort_Regression2)),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q42021_Cohort_Regression2)),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster, data = Q12022_Cohort_Regression)),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q12022_Cohort_Regression)),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster, data = Q12022_Cohort_Regression2)),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q12022_Cohort_Regression2)),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster, data = Q22022_Cohort_Regression)),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q22022_Cohort_Regression)),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster, data = Q22022_Cohort_Regression2)),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q22022_Cohort_Regression2)),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster, data = Q32022_Cohort_Regression)),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q32022_Cohort_Regression)),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster, data = Q32022_Cohort_Regression2)),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q32022_Cohort_Regression2))
)
```

```{r}
forest_nonmatched_severe <- rbind.data.frame(
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster, data = Q42021_Cohort_Regression)),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q42021_Cohort_Regression)),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster, data = Q42021_Cohort_Regression2)),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q42021_Cohort_Regression2)),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster, data = Q12022_Cohort_Regression)),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q12022_Cohort_Regression)),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster, data = Q12022_Cohort_Regression2)),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q12022_Cohort_Regression2)),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster, data = Q22022_Cohort_Regression)),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q22022_Cohort_Regression)),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster, data = Q22022_Cohort_Regression2)),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q22022_Cohort_Regression2)),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster, data = Q32022_Cohort_Regression)),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q32022_Cohort_Regression)),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster, data = Q32022_Cohort_Regression2)),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q32022_Cohort_Regression2))
)
```

## Survival Time Capped

```{r}
ggsurvplot(survfit(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster, data = SurvivalTime_Cap(Q42021_Cohort_Regression)),
           conf.int = TRUE,
           fun = "cumhaz")
```

```{r}
forest_nonmatched_infection <- rbind.data.frame(
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster, data = SurvivalTime_Cap(Q42021_Cohort_Regression))),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = SurvivalTime_Cap(Q42021_Cohort_Regression))),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster, data = SurvivalTime_Cap(Q42021_Cohort_Regression2))),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = SurvivalTime_Cap(Q42021_Cohort_Regression2))),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster, data = SurvivalTime_Cap(Q12022_Cohort_Regression))),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = SurvivalTime_Cap(Q12022_Cohort_Regression))),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster, data = SurvivalTime_Cap(Q12022_Cohort_Regression2))),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = SurvivalTime_Cap(Q12022_Cohort_Regression2))),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster, data = SurvivalTime_Cap(Q22022_Cohort_Regression))),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = SurvivalTime_Cap(Q22022_Cohort_Regression))),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster, data = SurvivalTime_Cap(Q22022_Cohort_Regression2))),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = SurvivalTime_Cap(Q22022_Cohort_Regression2))),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster, data = SurvivalTime_Cap(Q32022_Cohort_Regression))),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = SurvivalTime_Cap(Q32022_Cohort_Regression))),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster, data = SurvivalTime_Cap(Q32022_Cohort_Regression2))),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = SurvivalTime_Cap(Q32022_Cohort_Regression2)))
)
```

```{r}
ggsurvplot(survfit(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster, data = SurvivalTime_Cap(Q42021_Cohort_Regression)),
           conf.int = TRUE,
           fun = "cumhaz")
```

```{r}
forest_nonmatched_severe <- rbind.data.frame(
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster, SurvivalTime_Cap(data = Q42021_Cohort_Regression))),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = SurvivalTime_Cap(Q42021_Cohort_Regression))),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster, data = SurvivalTime_Cap(Q42021_Cohort_Regression2))),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = SurvivalTime_Cap(Q42021_Cohort_Regression2))),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster, data = SurvivalTime_Cap(Q12022_Cohort_Regression))),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = SurvivalTime_Cap(Q12022_Cohort_Regression))),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster, data = SurvivalTime_Cap(Q12022_Cohort_Regression2))),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = SurvivalTime_Cap(Q12022_Cohort_Regression2))),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster, data = SurvivalTime_Cap(Q22022_Cohort_Regression))),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = SurvivalTime_Cap(Q22022_Cohort_Regression))),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster, data = SurvivalTime_Cap(Q22022_Cohort_Regression2))),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = SurvivalTime_Cap(Q22022_Cohort_Regression2))),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster, data = SurvivalTime_Cap(Q32022_Cohort_Regression))),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = SurvivalTime_Cap(Q32022_Cohort_Regression))),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster, data = SurvivalTime_Cap(Q32022_Cohort_Regression2))),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = SurvivalTime_Cap(Q32022_Cohort_Regression2)))
)
```

### Combined Figure

```{r, fig.width = 7, fig.height = 10}
p1 <- ggsurvplot(survfit(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster, data = SurvivalTime_Cap(Q42021_Cohort_Regression)),
           conf.int = TRUE,
           fun = "cumhaz") +
  labs(title = "Infection")
p2 <- ggsurvplot(survfit(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster, data = SurvivalTime_Cap(Q42021_Cohort_Regression)),
           conf.int = TRUE,
           fun = "cumhaz") +
  labs(title = "Severe Disease")

arrange_ggsurvplots(list(p1, p2), ncol = 1, nrow = 2)
```


# Matching

## Propensity Models

```{r}
Q42021_Cohort_Regression_CC <- Q42021_Cohort_Regression %>%
  filter(!is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(index))

Q42021_Cohort_Regression2_CC <- Q42021_Cohort_Regression2 %>%
  filter(!is.na(Sex) & !is.na(BMI) & !is.na(BMI_category) & !is.na(disadvantage2_13_17_qrtl) & !is.na(index))

# Run only if doing 3 (within 120 days) vs 2 
#Q42021_Cohort_Regression2_CC <- Q42021_Cohort_Regression_CC

Propensity_ForBooster_Mod <- glm(Booster ~ Age + Sex + RaceEthnicity4 + BMI +
                                   disadvantage2_13_17_qrtl + popden13_17_qrtl + 
                                   HCW + index + PrimaryCareMM_Ind + negativeTests_Cat,
                                 family = "binomial",
                                 data = Q42021_Cohort_Regression2_CC)
Q42021_Cohort_Regression_PropensityScores <- Q42021_Cohort_Regression2_CC %>%
  mutate(Propensity_ForBooster = predict(Propensity_ForBooster_Mod, type = "response")) %>%
  mutate(IPW_ForBooster = ifelse(Booster == 1, yes = 1 / Propensity_ForBooster, no = 1 / (1 - Propensity_ForBooster)))

Propensity_ForTesting_Mod <- glm(negativeTests_Ind ~ Age + Sex + RaceEthnicity4 + BMI +
                                   disadvantage2_13_17_qrtl + popden13_17_qrtl + 
                                   HCW + index + PrimaryCareMM_Ind,
                                 family = "binomial",
                                 data = Q42021_Cohort_Regression2_CC)
Q42021_Cohort_Regression_PropensityScores <- Q42021_Cohort_Regression_PropensityScores %>%
  mutate(Propensity_ForTesting = predict(Propensity_ForTesting_Mod, type = "response")) %>%
  mutate(IPW_ForTesting = ifelse(negativeTests_Ind == 1, yes = 1 / Propensity_ForTesting, no = 1 / (1 - Propensity_ForTesting)))
```

```{r}
#summary(Propensity_ForBooster_Mod)
tidy_Propensity_ForBooster_Mod <- tidy(Propensity_ForBooster_Mod, conf.int = TRUE)
#summary(Propensity_ForTesting_Mod)
tidy_Propensity_ForTesting_Mod <- tidy(Propensity_ForTesting_Mod, conf.int = TRUE)
```

```{r}
#summary(Propensity_ForBooster_Mod)
tidy_Propensity_ForBooster_Mod <- tidy(Propensity_ForBooster_Mod, conf.int = TRUE)
#summary(Propensity_ForTesting_Mod)
tidy_Propensity_ForTesting_Mod <- tidy(Propensity_ForTesting_Mod, conf.int = TRUE)
```

```{r}
for(i in 1:nrow(tidy_Propensity_ForBooster_Mod)){
  print(
    paste0(
      tidy_Propensity_ForBooster_Mod$term[i],
      ":",
      " ",
      round(tidy_Propensity_ForBooster_Mod$estimate[i], 2),
      " ",
      "(",
      round(tidy_Propensity_ForBooster_Mod$conf.low[i], 2),
      ", ",
      round(tidy_Propensity_ForBooster_Mod$conf.high[i], 2),
      ")"
    )
  )
  print(
    paste0(
      "p = ",
      round(tidy_Propensity_ForBooster_Mod$p.value[i], 2)
    )
  )
}
```

```{r}
for(i in 1:nrow(tidy_Propensity_ForTesting_Mod)){
  print(
    paste0(
      tidy_Propensity_ForTesting_Mod$term[i],
      ":",
      " ",
      round(tidy_Propensity_ForTesting_Mod$estimate[i], 2),
      " ",
      "(",
      round(tidy_Propensity_ForTesting_Mod$conf.low[i], 2),
      ", ",
      round(tidy_Propensity_ForTesting_Mod$conf.high[i], 2),
      ")"
    )
  )
  print(
    paste0(
      "p = ",
      round(tidy_Propensity_ForTesting_Mod$p.value[i], 2)
    )
  )
}
```

```{r}
cor(Q42021_Cohort_Regression_PropensityScores$Propensity_ForBooster, Q42021_Cohort_Regression_PropensityScores$Propensity_ForTesting)
cor(Q42021_Cohort_Regression_PropensityScores$Propensity_ForBooster, Q42021_Cohort_Regression_PropensityScores$Propensity_ForTesting, 
    method = "spearman")
ggplot(Q42021_Cohort_Regression_PropensityScores, aes(x = Propensity_ForBooster, y = Propensity_ForTesting)) +
  geom_point(alpha = 0.02) +
  geom_smooth(method = "lm")
```

## Making Matches

```{r}
Q42021_Cohort_Regression_Exact_ForBoosting <- matchit(Booster ~ AgeCategory + Sex + RaceEthnicity4 + BMI_category +
                                                        disadvantage2_13_17_qrtl + popden13_17_qrtl + 
                                                        HCW + index + PrimaryCareMM_Ind + negativeTests_Cat,
                                                      data = Q42021_Cohort_Regression2_CC,
                                                      method = "exact") %>%
  match.data()
```

```{r}
Q42021_Cohort_Regression_Exact_ForTesting <- matchit(negativeTests_Ind ~ AgeCategory + Sex + RaceEthnicity4 + BMI_category +
                                                        disadvantage2_13_17_qrtl + popden13_17_qrtl + 
                                                        HCW + index + PrimaryCareMM_Ind,
                                                      data = Q42021_Cohort_Regression2_CC,
                                                      method = "exact") %>%
  match.data()
```

```{r}
Q42021_Cohort_Regression_PropensityCaliper_ForBoosting <- matchit(Booster ~ Age + Sex + RaceEthnicity4 + BMI +
                                                                    disadvantage2_13_17_qrtl + popden13_17_qrtl + 
                                                                    HCW + index + PrimaryCareMM_Ind + negativeTests_Cat,
                                                                  data = Q42021_Cohort_Regression2_CC,
                                                                  method = "nearest",
                                                                  distance = "glm",
                                                                  caliper = 0.2,
                                                                  std.caliper = TRUE) %>%
  match.data() %>%
  mutate(ipw = ifelse(Booster == 1, yes = 1 / distance, no = 1 / (1 - distance) ))
```

```{r}
Q42021_Cohort_Regression_PropensityCaliper_ForTesting <- matchit(negativeTests_Ind ~ Age + Sex + RaceEthnicity4 + BMI +
                                                                   disadvantage2_13_17_qrtl + popden13_17_qrtl + 
                                                                   HCW + index + PrimaryCareMM_Ind,
                                                                  data = Q42021_Cohort_Regression2_CC,
                                                                  method = "nearest",
                                                                  distance = "glm",
                                                                  caliper = 0.2,
                                                                  std.caliper = TRUE) %>%
  match.data() %>%
  mutate(ipw = ifelse(Booster == 1, yes = 1 / distance, no = 1 / (1 - distance) ))
```

## Cox Regression

### Exact Matching

#### Infection

```{r}
ggsurvplot(survfit(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster, data = Q42021_Cohort_Regression_Exact_ForBoosting),
           conf.int = TRUE,
           fun = "cumhaz")
```

```{r}
# For propensity for boosting
summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster, data = Q42021_Cohort_Regression_Exact_ForBoosting))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster, data = Q42021_Cohort_Regression_Exact_ForBoosting))$conf.int
```

```{r}
# For propensity for boosting
# Stratified
summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster + strata(subclass), data = Q42021_Cohort_Regression_Exact_ForBoosting))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster + strata(subclass), data = Q42021_Cohort_Regression_Exact_ForBoosting))$conf.int
```

```{r}
# For propensity for testing
summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster, data = Q42021_Cohort_Regression_Exact_ForTesting))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster, data = Q42021_Cohort_Regression_Exact_ForTesting))$conf.int
```

```{r}
# For propensity for testing
# Stratified
summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster + strata(subclass), data = Q42021_Cohort_Regression_Exact_ForTesting))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster + strata(subclass), data = Q42021_Cohort_Regression_Exact_ForTesting))$conf.int
```

#### Hospitalization

```{r}
# For propensity for boosting
summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster, data = Q42021_Cohort_Regression_Exact_ForBoosting))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster, data = Q42021_Cohort_Regression_Exact_ForBoosting))$conf.int
```

```{r}
# For propensity for boosting
# Stratified
summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster + strata(subclass), data = Q42021_Cohort_Regression_Exact_ForBoosting))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster + strata(subclass), data = Q42021_Cohort_Regression_Exact_ForBoosting))$conf.int
```

```{r}
# For propensity for testing
summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster, data = Q42021_Cohort_Regression_Exact_ForTesting))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster, data = Q42021_Cohort_Regression_Exact_ForTesting))$conf.int
```

```{r}
# For propensity for testing
# Stratified
summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster + strata(subclass), data = Q42021_Cohort_Regression_Exact_ForTesting))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster + strata(subclass), data = Q42021_Cohort_Regression_Exact_ForTesting))$conf.int
```

### Caliper Propensity Matching

#### Infection

```{r}
ggsurvplot(survfit(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster, data = Q42021_Cohort_Regression_PropensityCaliper_ForBoosting),
           conf.int = TRUE,
           fun = "cumhaz")
```

```{r}
# For propensity for boosting
summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster, data = Q42021_Cohort_Regression_PropensityCaliper_ForBoosting))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster, data = Q42021_Cohort_Regression_PropensityCaliper_ForBoosting))$conf.int
```

```{r}
# For propensity for boosting
# Stratified
summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster + strata(subclass), 
              data = Q42021_Cohort_Regression_PropensityCaliper_ForBoosting))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster + strata(subclass), 
              data = Q42021_Cohort_Regression_PropensityCaliper_ForBoosting))$conf.int
```

```{r}
# For propensity for testing
summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster, data = Q42021_Cohort_Regression_PropensityCaliper_ForTesting))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster, data = Q42021_Cohort_Regression_PropensityCaliper_ForTesting))$conf.int
```

```{r}
# For propensity for testing
# Stratified
summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster + strata(subclass), data = Q42021_Cohort_Regression_PropensityCaliper_ForTesting))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster + strata(subclass), data = Q42021_Cohort_Regression_PropensityCaliper_ForTesting))$conf.int
```

#### Hospitalization

```{r}
# For propensity for boosting
summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster, data = Q42021_Cohort_Regression_PropensityCaliper_ForBoosting))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster, data = Q42021_Cohort_Regression_PropensityCaliper_ForBoosting))$conf.int
```

```{r}
# For propensity for boosting
# Stratified
summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster + strata(subclass), data = Q42021_Cohort_Regression_PropensityCaliper_ForBoosting))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster + strata(subclass), data = Q42021_Cohort_Regression_PropensityCaliper_ForBoosting))$conf.int
```

```{r}
# For propensity for testing
summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster, data = Q42021_Cohort_Regression_PropensityCaliper_ForTesting))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster, data = Q42021_Cohort_Regression_PropensityCaliper_ForTesting))$conf.int
```

```{r}
# For propensity for testing
# Stratified
summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster + strata(subclass), data = Q42021_Cohort_Regression_PropensityCaliper_ForTesting))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster + strata(subclass), data = Q42021_Cohort_Regression_PropensityCaliper_ForTesting))$conf.int
```

### Propensity Adjustment

#### Infection

```{r}
ggsurvplot(survfit(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster, data = Q42021_Cohort_Regression_PropensityScores),
           conf.int = TRUE,
           fun = "cumhaz")
```

```{r}
# For propensity for boosting
summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster + Propensity_ForBooster, data = Q42021_Cohort_Regression_PropensityScores))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster + Propensity_ForBooster, data = Q42021_Cohort_Regression_PropensityScores))$conf.int
```

```{r}
# For propensity for boosting
# Fully Adjusted
summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster + Propensity_ForBooster + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q42021_Cohort_Regression_PropensityScores))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster + Propensity_ForBooster + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q42021_Cohort_Regression_PropensityScores))$conf.int
```

```{r}
# Propensity for testing
summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster + Propensity_ForTesting, data = Q42021_Cohort_Regression_PropensityScores))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster + Propensity_ForTesting, data = Q42021_Cohort_Regression_PropensityScores))$conf.int
```

```{r}
# Propensity for testing
# Fully Adjusted
summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster + Propensity_ForTesting + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind, data = Q42021_Cohort_Regression_PropensityScores))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster + Propensity_ForTesting + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind, data = Q42021_Cohort_Regression_PropensityScores))$conf.int
```

```{r}
# For both propensity scores
summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster + Propensity_ForBooster + Propensity_ForTesting, 
              data = Q42021_Cohort_Regression_PropensityScores))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster + Propensity_ForBooster + Propensity_ForTesting, 
              data = Q42021_Cohort_Regression_PropensityScores))$conf.int
```

```{r}
# For both propensity scores
# Fully Adjusted
summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster + Propensity_ForBooster + Propensity_ForTesting + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind, data = Q42021_Cohort_Regression_PropensityScores))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster + Propensity_ForBooster + Propensity_ForTesting + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind, data = Q42021_Cohort_Regression_PropensityScores))$conf.int
```

#### Hospitalization

```{r}
ggsurvplot(survfit(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster, data = Q42021_Cohort_Regression_PropensityScores),
           conf.int = TRUE,
           fun = "cumhaz")
```

```{r}
# For propensity for boosting
summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster + Propensity_ForBooster, data = Q42021_Cohort_Regression_PropensityScores))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster + Propensity_ForBooster, data = Q42021_Cohort_Regression_PropensityScores))$conf.int
```

```{r}
# For propensity for boosting
# Fully Adjusted
summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster + Propensity_ForBooster + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q42021_Cohort_Regression_PropensityScores))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster + Propensity_ForBooster + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q42021_Cohort_Regression_PropensityScores))$conf.int
```

```{r}
# Propensity for testing
summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster + Propensity_ForTesting, data = Q42021_Cohort_Regression_PropensityScores))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster + Propensity_ForTesting, data = Q42021_Cohort_Regression_PropensityScores))$conf.int
```

```{r}
# Propensity for testing
# Fully Adjusted
summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster + Propensity_ForTesting + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind, data = Q42021_Cohort_Regression_PropensityScores))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster + Propensity_ForTesting + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind, data = Q42021_Cohort_Regression_PropensityScores))$conf.int
```

```{r}
# For both propensity scores
summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster + Propensity_ForBooster + Propensity_ForTesting, data = Q42021_Cohort_Regression_PropensityScores))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster + Propensity_ForBooster + Propensity_ForTesting, data = Q42021_Cohort_Regression_PropensityScores))$conf.int
```

```{r}
# For both propensity scores
# Fully adjusted
summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster + Propensity_ForBooster + Propensity_ForTesting + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind, data = Q42021_Cohort_Regression_PropensityScores))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster + Propensity_ForBooster + Propensity_ForTesting + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind, data = Q42021_Cohort_Regression_PropensityScores))$conf.int
```


### IPW

#### Infection

```{r}
# For propensity for boosting
summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster , weights = IPW_ForBooster, data = Q42021_Cohort_Regression_PropensityScores))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster , weights = IPW_ForBooster, data = Q42021_Cohort_Regression_PropensityScores))$conf.int
```

```{r}
# For propensity for boosting
# Fully Adjusted
summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, weights = IPW_ForBooster, data = Q42021_Cohort_Regression_PropensityScores))
```

```{r}
# For propensity for testing
summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster, weights = IPW_ForTesting, data = Q42021_Cohort_Regression_PropensityScores))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster, weights = IPW_ForTesting, data = Q42021_Cohort_Regression_PropensityScores))$conf.int
```

```{r}
# For propensity for testing
# Fully Adjusted
summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind, weights = IPW_ForTesting, data = Q42021_Cohort_Regression_PropensityScores))
```

#### Hospitalization

```{r}
# For propensity for boosting
summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster, weights = IPW_ForBooster, data = Q42021_Cohort_Regression_PropensityScores))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster, weights = IPW_ForBooster, data = Q42021_Cohort_Regression_PropensityScores))$conf.int
```

```{r}
# For propensity for boosting
# Fully adjusted
summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, weights = IPW_ForBooster, data = Q42021_Cohort_Regression_PropensityScores))
```

```{r}
# For propensity for testing
summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster, weights = IPW_ForTesting, data = Q42021_Cohort_Regression_PropensityScores))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster, weights = IPW_ForTesting, data = Q42021_Cohort_Regression_PropensityScores))$conf.int
```

```{r}
# For propensity for testing
# Fully adjusted
summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind, weights = IPW_ForTesting, data = Q42021_Cohort_Regression_PropensityScores))
```

## Matched Model Extraction

```{r}
forest_matched_infection <- rbind.data.frame(
  # Non-Matched Reference
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster, data = Q42021_Cohort_Regression2_CC)),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q42021_Cohort_Regression2_CC)),
  # For Boosting
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster, data = Q42021_Cohort_Regression_Exact_ForBoosting)),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster + strata(subclass), data = Q42021_Cohort_Regression_Exact_ForBoosting)),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster, data = Q42021_Cohort_Regression_PropensityCaliper_ForBoosting)),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster + strata(subclass), 
              data = Q42021_Cohort_Regression_PropensityCaliper_ForBoosting)),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster + Propensity_ForBooster, data = Q42021_Cohort_Regression_PropensityScores)),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster + Propensity_ForBooster + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q42021_Cohort_Regression_PropensityScores)),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster , weights = IPW_ForBooster, data = Q42021_Cohort_Regression_PropensityScores)),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, weights = IPW_ForBooster, data = Q42021_Cohort_Regression_PropensityScores)),
  # For Testing
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster, data = Q42021_Cohort_Regression_Exact_ForTesting)),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster + strata(subclass), data = Q42021_Cohort_Regression_Exact_ForTesting)),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster, data = Q42021_Cohort_Regression_PropensityCaliper_ForTesting)),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster + strata(subclass), data = Q42021_Cohort_Regression_PropensityCaliper_ForTesting)),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster + Propensity_ForTesting, data = Q42021_Cohort_Regression_PropensityScores)),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster + Propensity_ForTesting + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind, data = Q42021_Cohort_Regression_PropensityScores)),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster, weights = IPW_ForTesting, data = Q42021_Cohort_Regression_PropensityScores)),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind, weights = IPW_ForTesting, data = Q42021_Cohort_Regression_PropensityScores)),
  # Both
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster + Propensity_ForBooster + Propensity_ForTesting, 
              data = Q42021_Cohort_Regression_PropensityScores)),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, weights = IPW_ForBooster, data = Q42021_Cohort_Regression_PropensityScores))
)
```

```{r}
forest_matched_severe <- rbind.data.frame(
  # Non-Matched Reference
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster, data = Q42021_Cohort_Regression2_CC)),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q42021_Cohort_Regression2_CC)),
  # For Boosting
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster, data = Q42021_Cohort_Regression_Exact_ForBoosting)),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster + strata(subclass), data = Q42021_Cohort_Regression_Exact_ForBoosting)),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster, data = Q42021_Cohort_Regression_PropensityCaliper_ForBoosting)),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster + strata(subclass), 
              data = Q42021_Cohort_Regression_PropensityCaliper_ForBoosting)),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster + Propensity_ForBooster, data = Q42021_Cohort_Regression_PropensityScores)),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster + Propensity_ForBooster + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q42021_Cohort_Regression_PropensityScores)),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster , weights = IPW_ForBooster, data = Q42021_Cohort_Regression_PropensityScores)),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, weights = IPW_ForBooster, data = Q42021_Cohort_Regression_PropensityScores)),
  # For Testing
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster, data = Q42021_Cohort_Regression_Exact_ForTesting)),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster + strata(subclass), data = Q42021_Cohort_Regression_Exact_ForTesting)),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster, data = Q42021_Cohort_Regression_PropensityCaliper_ForTesting)),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster + strata(subclass), data = Q42021_Cohort_Regression_PropensityCaliper_ForTesting)),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster + Propensity_ForTesting, data = Q42021_Cohort_Regression_PropensityScores)),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster + Propensity_ForTesting + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind, data = Q42021_Cohort_Regression_PropensityScores)),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster, weights = IPW_ForTesting, data = Q42021_Cohort_Regression_PropensityScores)),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind, weights = IPW_ForTesting, data = Q42021_Cohort_Regression_PropensityScores)),
  # Both
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster + Propensity_ForBooster + Propensity_ForTesting, 
              data = Q42021_Cohort_Regression_PropensityScores)),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, weights = IPW_ForBooster, data = Q42021_Cohort_Regression_PropensityScores))
)
```

### Survival Time Capped

```{r}
forest_matched_infection <- rbind.data.frame(
  # Non-Matched Reference
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster, data = SurvivalTime_Cap(Q42021_Cohort_Regression2_CC))),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = SurvivalTime_Cap(Q42021_Cohort_Regression2_CC))),
  # For Boosting
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster, data = SurvivalTime_Cap(Q42021_Cohort_Regression_Exact_ForBoosting))),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster + strata(subclass), data = SurvivalTime_Cap(Q42021_Cohort_Regression_Exact_ForBoosting))),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster, data = SurvivalTime_Cap(Q42021_Cohort_Regression_PropensityCaliper_ForBoosting))),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster + strata(subclass), 
              data = SurvivalTime_Cap(Q42021_Cohort_Regression_PropensityCaliper_ForBoosting))),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster + Propensity_ForBooster, data = SurvivalTime_Cap(Q42021_Cohort_Regression_PropensityScores))),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster + Propensity_ForBooster + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = SurvivalTime_Cap(Q42021_Cohort_Regression_PropensityScores))),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster , weights = IPW_ForBooster, data = SurvivalTime_Cap(Q42021_Cohort_Regression_PropensityScores))),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, weights = IPW_ForBooster, data = SurvivalTime_Cap(Q42021_Cohort_Regression_PropensityScores))),
  # For Testing
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster, data = SurvivalTime_Cap(Q42021_Cohort_Regression_Exact_ForTesting))),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster + strata(subclass), data = SurvivalTime_Cap(Q42021_Cohort_Regression_Exact_ForTesting))),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster, data = SurvivalTime_Cap(Q42021_Cohort_Regression_PropensityCaliper_ForTesting))),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster + strata(subclass), data = SurvivalTime_Cap(Q42021_Cohort_Regression_PropensityCaliper_ForTesting))),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster + Propensity_ForTesting, data = SurvivalTime_Cap(Q42021_Cohort_Regression_PropensityScores))),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster + Propensity_ForTesting + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind, data = SurvivalTime_Cap(Q42021_Cohort_Regression_PropensityScores))),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster, weights = IPW_ForTesting, data = SurvivalTime_Cap(Q42021_Cohort_Regression_PropensityScores))),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind, weights = IPW_ForTesting, data = SurvivalTime_Cap(Q42021_Cohort_Regression_PropensityScores))),
  # Both
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster + Propensity_ForBooster + Propensity_ForTesting, 
              data = SurvivalTime_Cap(Q42021_Cohort_Regression_PropensityScores))),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, weights = IPW_ForBooster, data = SurvivalTime_Cap(Q42021_Cohort_Regression_PropensityScores)))
)
```

```{r}
forest_matched_severe <- rbind.data.frame(
  # Non-Matched Reference
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster, data = SurvivalTime_Cap(Q42021_Cohort_Regression2_CC))),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = SurvivalTime_Cap(Q42021_Cohort_Regression2_CC))),
  # For Boosting
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster, data = SurvivalTime_Cap(Q42021_Cohort_Regression_Exact_ForBoosting))),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster + strata(subclass), data = SurvivalTime_Cap(Q42021_Cohort_Regression_Exact_ForBoosting))),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster, data = SurvivalTime_Cap(Q42021_Cohort_Regression_PropensityCaliper_ForBoosting))),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster + strata(subclass), 
              data = SurvivalTime_Cap(Q42021_Cohort_Regression_PropensityCaliper_ForBoosting))),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster + Propensity_ForBooster, data = SurvivalTime_Cap(Q42021_Cohort_Regression_PropensityScores))),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster + Propensity_ForBooster + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = SurvivalTime_Cap(Q42021_Cohort_Regression_PropensityScores))),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster , weights = IPW_ForBooster, data = SurvivalTime_Cap(Q42021_Cohort_Regression_PropensityScores))),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, weights = IPW_ForBooster, data = SurvivalTime_Cap(Q42021_Cohort_Regression_PropensityScores))),
  # For Testing
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster, data = SurvivalTime_Cap(Q42021_Cohort_Regression_Exact_ForTesting))),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster + strata(subclass), data = SurvivalTime_Cap(Q42021_Cohort_Regression_Exact_ForTesting))),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster, data = SurvivalTime_Cap(Q42021_Cohort_Regression_PropensityCaliper_ForTesting))),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster + strata(subclass), data = SurvivalTime_Cap(Q42021_Cohort_Regression_PropensityCaliper_ForTesting))),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster + Propensity_ForTesting, data = SurvivalTime_Cap(Q42021_Cohort_Regression_PropensityScores))),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster + Propensity_ForTesting + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind, data = SurvivalTime_Cap(Q42021_Cohort_Regression_PropensityScores))),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster, weights = IPW_ForTesting, data = SurvivalTime_Cap(Q42021_Cohort_Regression_PropensityScores))),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind, weights = IPW_ForTesting, data = SurvivalTime_Cap(Q42021_Cohort_Regression_PropensityScores))),
  # Both
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster + Propensity_ForBooster + Propensity_ForTesting, 
              data = SurvivalTime_Cap(Q42021_Cohort_Regression_PropensityScores))),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, weights = IPW_ForBooster, data = SurvivalTime_Cap(Q42021_Cohort_Regression_PropensityScores)))
)
```

# Second Booster

## Boosted At Quarter Models

### Q2 2022

```{r}
Q22022_tab_infection <- table(Q22022_Booster2_Cohort_Regression$Booster2, Q22022_Booster2_Cohort_Regression$Infection_InPeriod)
Q22022_tab_infection
Q22022_tab_infection[2,2] * Q22022_tab_infection[1,1] / (Q22022_tab_infection[1,2] * Q22022_tab_infection[2,1])
Q22022_tab_hospitalization <- table(Q22022_Booster2_Cohort_Regression$Booster2, Q22022_Booster2_Cohort_Regression$Hosp_InPeriod)
Q22022_tab_hospitalization
Q22022_tab_hospitalization[2,2] * Q22022_tab_hospitalization[1,1] / (Q22022_tab_hospitalization[1,2] * Q22022_tab_hospitalization[2,1])
```

```{r}
# Unadjusted Infection Model
summary(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster2, data = Q22022_Booster2_Cohort_Regression))
1 - summary(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster2, data = Q22022_Booster2_Cohort_Regression))$conf.int
```

```{r}
ggsurvplot(survfit(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster2, data = Q22022_Booster2_Cohort_Regression),
           conf.int = TRUE,
           fun = "cumhaz")
```

```{r}
# Adjusted Infection Model
summary(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster2 + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q22022_Booster2_Cohort_Regression))
1 - summary(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster2 + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q22022_Booster2_Cohort_Regression))$conf.int
```

```{r}
# Unadjusted Severe Disease Model
summary(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster2, data = Q22022_Booster2_Cohort_Regression))
1 - summary(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster2, data = Q22022_Booster2_Cohort_Regression))$conf.int
```

```{r}
ggsurvplot(survfit(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster2, data = Q22022_Booster2_Cohort_Regression),
           conf.int = TRUE,
           fun = "cumhaz")
```

```{r}
# Adjusted Severe Disease Model
summary(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster2 + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q22022_Booster2_Cohort_Regression))
1 - summary(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster2 + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q22022_Booster2_Cohort_Regression))$conf.int
```

### Q3 2022

```{r}
# Unadjusted Infection Model
summary(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster2, data = Q32022_Booster2_Cohort_Regression))
1 - summary(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster2, data = Q32022_Booster2_Cohort_Regression))$conf.int
```

```{r}
ggsurvplot(survfit(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster2, data = Q32022_Booster2_Cohort_Regression),
           conf.int = TRUE,
           fun = "cumhaz")
```

```{r}
# Adjusted Infection Model
summary(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster2 + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q32022_Booster2_Cohort_Regression))
1 - summary(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster2 + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q32022_Booster2_Cohort_Regression))$conf.int
```

```{r}
# Unadjusted Severe Disease Model
summary(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster2, data = Q32022_Booster2_Cohort_Regression))
1 - summary(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster2, data = Q32022_Booster2_Cohort_Regression))$conf.int
```

```{r}
ggsurvplot(survfit(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster2, data = Q32022_Booster2_Cohort_Regression),
           conf.int = TRUE,
           fun = "cumhaz")
```

```{r}
# Adjusted Severe Disease Model
summary(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster2 + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q32022_Booster2_Cohort_Regression))
1 - summary(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster2 + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q32022_Booster2_Cohort_Regression))$conf.int
```

## Boosted Since Quarter Models

### Q2 2022

```{r}
# Unadjusted Infection Model
summary(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster2, data = Q22022_Booster2_Cohort_Regression2))
1 - summary(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster2, data = Q22022_Booster2_Cohort_Regression2))$conf.int
```

```{r}
ggsurvplot(survfit(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster2, data = Q22022_Booster2_Cohort_Regression2),
           conf.int = TRUE,
           fun = "cumhaz")
```

```{r}
# Adjusted Infection Model
summary(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster2 + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q22022_Booster2_Cohort_Regression2))
1 - summary(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster2 + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q22022_Booster2_Cohort_Regression2))$conf.int
```

```{r}
# Unadjusted Severe Disease Model
summary(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster2, data = Q22022_Booster2_Cohort_Regression2))
1 - summary(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster2, data = Q22022_Booster2_Cohort_Regression2))$conf.int
```

```{r}
ggsurvplot(survfit(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster2, data = Q22022_Booster2_Cohort_Regression2),
           conf.int = TRUE,
           fun = "cumhaz")
```

```{r}
# Adjusted Severe Disease Model
summary(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster2 + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q22022_Booster2_Cohort_Regression2))
1 - summary(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster2 + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q22022_Booster2_Cohort_Regression2))$conf.int
```

### Q3 2022

```{r}
# Unadjusted Infection Model
summary(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster2, data = Q32022_Booster2_Cohort_Regression2))
1 - summary(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster2, data = Q32022_Booster2_Cohort_Regression2))$conf.int
```

```{r}
ggsurvplot(survfit(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster2, data = Q32022_Booster2_Cohort_Regression2),
           conf.int = TRUE,
           fun = "cumhaz")
```

```{r}
# Adjusted Infection Model
summary(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster2 + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q32022_Booster2_Cohort_Regression2))
1 - summary(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster2 + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q32022_Booster2_Cohort_Regression2))$conf.int
```

```{r}
# Unadjusted Severe Disease Model
summary(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster2, data = Q32022_Booster2_Cohort_Regression2))
1 - summary(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster2, data = Q32022_Booster2_Cohort_Regression2))$conf.int
```

```{r}
ggsurvplot(survfit(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster2, data = Q32022_Booster2_Cohort_Regression2),
           conf.int = TRUE,
           fun = "cumhaz")
```

```{r}
# Adjusted Severe Disease Model
summary(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster2 + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q32022_Booster2_Cohort_Regression2))
1 - summary(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster2 + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q32022_Booster2_Cohort_Regression2))$conf.int
```

## Non-Matched Model Extraction

```{r}
forest_nonmatched_infection <- rbind.data.frame(
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster2, data = Q22022_Booster2_Cohort_Regression)),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster2 + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q22022_Booster2_Cohort_Regression)),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster2, data = Q22022_Booster2_Cohort_Regression2)),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster2 + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q22022_Booster2_Cohort_Regression2)),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster2, data = Q32022_Booster2_Cohort_Regression)),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster2 + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q32022_Booster2_Cohort_Regression)),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster2, data = Q32022_Booster2_Cohort_Regression2)),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster2 + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q32022_Booster2_Cohort_Regression2))
)
```

```{r}
forest_nonmatched_severe <- rbind.data.frame(
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster2, data = Q22022_Booster2_Cohort_Regression)),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster2 + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q22022_Booster2_Cohort_Regression)),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster2, data = Q22022_Booster2_Cohort_Regression2)),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster2 + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q22022_Booster2_Cohort_Regression2)),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster2, data = Q32022_Booster2_Cohort_Regression)),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster2 + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q32022_Booster2_Cohort_Regression)),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster2, data = Q32022_Booster2_Cohort_Regression2)),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster2 + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q32022_Booster2_Cohort_Regression2))
)
```

## Matching

### Propensity Models

```{r}
Propensity_ForBooster_Mod <- glm(Booster2 ~ Age + Sex + RaceEthnicity4 + BMI +
                                   disadvantage2_13_17_qrtl + popden13_17_qrtl + 
                                   HCW + index + PrimaryCareMM_Ind + negativeTests_Cat,
                                 family = "binomial",
                                 data = Q22022_Booster2_Cohort_Regression2)
Q22022_Booster2_Cohort_Regression_PropensityScores <- Q22022_Booster2_Cohort_Regression2 %>%
  mutate(Propensity_ForBooster = predict(Propensity_ForBooster_Mod, type = "response")) %>%
  mutate(IPW_ForBooster = ifelse(Booster2 == 1, yes = 1 / Propensity_ForBooster, no = 1 / (1 - Propensity_ForBooster)))

Propensity_ForTesting_Mod <- glm(negativeTests_Ind ~ Age + Sex + RaceEthnicity4 + BMI +
                                   disadvantage2_13_17_qrtl + popden13_17_qrtl + 
                                   HCW + index + PrimaryCareMM_Ind,
                                 family = "binomial",
                                 data = Q22022_Booster2_Cohort_Regression2)
Q22022_Booster2_Cohort_Regression_PropensityScores <- Q22022_Booster2_Cohort_Regression_PropensityScores %>%
  mutate(Propensity_ForTesting = predict(Propensity_ForTesting_Mod, type = "response")) %>%
  mutate(IPW_ForTesting = ifelse(negativeTests_Ind == 1, yes = 1 / Propensity_ForTesting, no = 1 / (1 - Propensity_ForTesting)))
```

```{r}
Propensity_ForBooster_Mod <- glm(Booster2 ~ Age + Sex + RaceEthnicity4 + BMI +
                                   disadvantage2_13_17_qrtl + popden13_17_qrtl + 
                                   HCW + index + PrimaryCareMM_Ind + negativeTests_Cat,
                                 family = "binomial",
                                 data = Q32022_Booster2_Cohort_Regression)
Q32022_Booster2_Cohort_Regression_PropensityScores <- Q32022_Booster2_Cohort_Regression %>%
  mutate(Propensity_ForBooster = predict(Propensity_ForBooster_Mod, type = "response")) %>%
  mutate(IPW_ForBooster = ifelse(Booster2 == 1, yes = 1 / Propensity_ForBooster, no = 1 / (1 - Propensity_ForBooster)))

Propensity_ForTesting_Mod <- glm(negativeTests_Ind ~ Age + Sex + RaceEthnicity4 + BMI +
                                   disadvantage2_13_17_qrtl + popden13_17_qrtl + 
                                   HCW + index + PrimaryCareMM_Ind,
                                 family = "binomial",
                                 data = Q32022_Booster2_Cohort_Regression)
Q32022_Booster2_Cohort_Regression_PropensityScores <- Q32022_Booster2_Cohort_Regression_PropensityScores %>%
  mutate(Propensity_ForTesting = predict(Propensity_ForTesting_Mod, type = "response")) %>%
  mutate(IPW_ForTesting = ifelse(negativeTests_Ind == 1, yes = 1 / Propensity_ForTesting, no = 1 / (1 - Propensity_ForTesting)))
```

```{r}
cor(Q22022_Booster2_Cohort_Regression_PropensityScores$Propensity_ForBooster, Q22022_Booster2_Cohort_Regression_PropensityScores$Propensity_ForTesting)
ggplot(Q22022_Booster2_Cohort_Regression_PropensityScores, aes(x = Propensity_ForBooster, y = Propensity_ForTesting)) +
  geom_point(alpha = 0.02) +
  geom_smooth(method = "lm")
```

### Making Matches

```{r}
Q22022_Booster2_Cohort_Regression_Exact_ForBoosting <- matchit(Booster2 ~ AgeCategory + Sex + RaceEthnicity4 + BMI_category +
                                                        disadvantage2_13_17_qrtl + popden13_17_qrtl + 
                                                        HCW + index + PrimaryCareMM_Ind + negativeTests_Cat,
                                                      data = Q22022_Booster2_Cohort_Regression2,
                                                      method = "exact") %>%
  match.data()
```

```{r}
Q22022_Booster2_Cohort_Regression_Exact_ForTesting <- matchit(negativeTests_Ind ~ AgeCategory + Sex + RaceEthnicity4 + BMI_category +
                                                        disadvantage2_13_17_qrtl + popden13_17_qrtl + 
                                                        HCW + index + PrimaryCareMM_Ind,
                                                      data = Q22022_Booster2_Cohort_Regression2,
                                                      method = "exact") %>%
  match.data()
```

```{r}
Q22022_Booster2_Cohort_Regression_PropensityCaliper_ForBoosting <- matchit(Booster2 ~ Age + Sex + RaceEthnicity4 + BMI +
                                                                    disadvantage2_13_17_qrtl + popden13_17_qrtl + 
                                                                    HCW + index + PrimaryCareMM_Ind + negativeTests_Cat,
                                                                  data = Q22022_Booster2_Cohort_Regression2,
                                                                  method = "nearest",
                                                                  distance = "glm",
                                                                  caliper = 0.2,
                                                                  std.caliper = TRUE) %>%
  match.data() %>%
  mutate(ipw = ifelse(Booster == 1, yes = 1 / distance, no = 1 / (1 - distance) ))
```

```{r}
Q22022_Booster2_Cohort_Regression_PropensityCaliper_ForTesting <- matchit(negativeTests_Ind ~ Age + Sex + RaceEthnicity4 + BMI +
                                                                   disadvantage2_13_17_qrtl + popden13_17_qrtl + 
                                                                   HCW + index + PrimaryCareMM_Ind,
                                                                  data = Q22022_Booster2_Cohort_Regression2,
                                                                  method = "nearest",
                                                                  distance = "glm",
                                                                  caliper = 0.2,
                                                                  std.caliper = TRUE) %>%
  match.data() %>%
  mutate(ipw = ifelse(Booster == 1, yes = 1 / distance, no = 1 / (1 - distance) ))
```

## Matched Cox Regression

### Exact Matching

#### Infection

```{r}
ggsurvplot(survfit(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster2, data = Q22022_Booster2_Cohort_Regression_Exact_ForBoosting),
           conf.int = TRUE,
           fun = "cumhaz")
```

```{r}
# For propensity for boosting
summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster2, data = Q22022_Booster2_Cohort_Regression_Exact_ForBoosting))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster2, data = Q22022_Booster2_Cohort_Regression_Exact_ForBoosting))$conf.int
```

```{r}
# For propensity for boosting
# Stratified
summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster2 + strata(subclass), data = Q22022_Booster2_Cohort_Regression_Exact_ForBoosting))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster2 + strata(subclass), data = Q22022_Booster2_Cohort_Regression_Exact_ForBoosting))$conf.int
```

```{r}
# For propensity for testing
summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster2, data = Q22022_Booster2_Cohort_Regression_Exact_ForTesting))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster2, data = Q22022_Booster2_Cohort_Regression_Exact_ForTesting))$conf.int
```

```{r}
# For propensity for testing
# Stratified
summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster2 + strata(subclass), data = Q22022_Booster2_Cohort_Regression_Exact_ForTesting))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster2 + strata(subclass), data = Q22022_Booster2_Cohort_Regression_Exact_ForTesting))$conf.int
```

#### Hospitalization

```{r}
# For propensity for boosting
summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster2, data = Q22022_Booster2_Cohort_Regression_Exact_ForBoosting))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster2, data = Q22022_Booster2_Cohort_Regression_Exact_ForBoosting))$conf.int
```

```{r}
# For propensity for boosting
# Stratified
summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster2 + strata(subclass), data = Q22022_Booster2_Cohort_Regression_Exact_ForBoosting))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster2 + strata(subclass), data = Q22022_Booster2_Cohort_Regression_Exact_ForBoosting))$conf.int
```

```{r}
# For propensity for testing
summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster2, data = Q22022_Booster2_Cohort_Regression_Exact_ForTesting))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster2, data = Q22022_Booster2_Cohort_Regression_Exact_ForTesting))$conf.int
```

```{r}
# For propensity for testing
# Stratified
summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster2 + strata(subclass), data = Q22022_Booster2_Cohort_Regression_Exact_ForTesting))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster2 + strata(subclass), data = Q22022_Booster2_Cohort_Regression_Exact_ForTesting))$conf.int
```

### Caliper Propensity Matching

#### Infection

```{r}
ggsurvplot(survfit(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster2, data = Q22022_Booster2_Cohort_Regression_PropensityCaliper_ForBoosting),
           conf.int = TRUE,
           fun = "cumhaz")
```

```{r}
# For propensity for boosting
summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster2, data = Q22022_Booster2_Cohort_Regression_PropensityCaliper_ForBoosting))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster2, data = Q22022_Booster2_Cohort_Regression_PropensityCaliper_ForBoosting))$conf.int
```

```{r}
# For propensity for boosting
# Stratified
summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster2 + strata(subclass), 
              data = Q22022_Booster2_Cohort_Regression_PropensityCaliper_ForBoosting))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster2 + strata(subclass), 
              data = Q22022_Booster2_Cohort_Regression_PropensityCaliper_ForBoosting))$conf.int
```

```{r}
# For propensity for testing
summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster2, data = Q22022_Booster2_Cohort_Regression_PropensityCaliper_ForTesting))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster2, data = Q22022_Booster2_Cohort_Regression_PropensityCaliper_ForTesting))$conf.int
```

```{r}
# For propensity for testing
# Stratified
summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster2 + strata(subclass), data = Q22022_Booster2_Cohort_Regression_PropensityCaliper_ForTesting))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster2 + strata(subclass), data = Q22022_Booster2_Cohort_Regression_PropensityCaliper_ForTesting))$conf.int
```

#### Hospitalization

```{r}
# For propensity for boosting
summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster2, data = Q22022_Booster2_Cohort_Regression_PropensityCaliper_ForBoosting))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster2, data = Q22022_Booster2_Cohort_Regression_PropensityCaliper_ForBoosting))$conf.int
```

```{r}
# For propensity for boosting
# Stratified
summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster2 + strata(subclass), data = Q22022_Booster2_Cohort_Regression_PropensityCaliper_ForBoosting))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster2 + strata(subclass), data = Q22022_Booster2_Cohort_Regression_PropensityCaliper_ForBoosting))$conf.int
```

```{r}
# For propensity for testing
summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster2, data = Q22022_Booster2_Cohort_Regression_PropensityCaliper_ForTesting))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster2, data = Q22022_Booster2_Cohort_Regression_PropensityCaliper_ForTesting))$conf.int
```

```{r}
# For propensity for testing
# Stratified
summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster2 + strata(subclass), data = Q22022_Booster2_Cohort_Regression_PropensityCaliper_ForTesting))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster2 + strata(subclass), data = Q22022_Booster2_Cohort_Regression_PropensityCaliper_ForTesting))$conf.int
```

### Propensity Adjustment

#### Infection

```{r}
ggsurvplot(survfit(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster2, data = Q22022_Booster2_Cohort_Regression_PropensityScores),
           conf.int = TRUE,
           fun = "cumhaz")
```

```{r}
# For propensity for boosting
summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster2 + Propensity_ForBooster, data = Q22022_Booster2_Cohort_Regression_PropensityScores))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster2 + Propensity_ForBooster, data = Q22022_Booster2_Cohort_Regression_PropensityScores))$conf.int
```

```{r}
# For propensity for boosting
# Fully Adjusted
summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster2 + Propensity_ForBooster + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q22022_Booster2_Cohort_Regression_PropensityScores))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster2 + Propensity_ForBooster + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q22022_Booster2_Cohort_Regression_PropensityScores))$conf.int
```

```{r}
# Propensity for testing
summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster2 + Propensity_ForTesting, data = Q22022_Booster2_Cohort_Regression_PropensityScores))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster2 + Propensity_ForTesting, data = Q22022_Booster2_Cohort_Regression_PropensityScores))$conf.int
```

```{r}
# Propensity for testing
# Fully Adjusted
summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster2 + Propensity_ForTesting + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind, data = Q22022_Booster2_Cohort_Regression_PropensityScores))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster2 + Propensity_ForTesting + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind, data = Q22022_Booster2_Cohort_Regression_PropensityScores))$conf.int
```

```{r}
# For both propensity scores
summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster2 + Propensity_ForBooster + Propensity_ForTesting, 
              data = Q22022_Booster2_Cohort_Regression_PropensityScores))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster2 + Propensity_ForBooster + Propensity_ForTesting, 
              data = Q22022_Booster2_Cohort_Regression_PropensityScores))$conf.int
```

```{r}
# For both propensity scores
# Fully Adjusted
summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster2 + Propensity_ForBooster + Propensity_ForTesting + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind, data = Q22022_Booster2_Cohort_Regression_PropensityScores))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster2 + Propensity_ForBooster + Propensity_ForTesting + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind, data = Q22022_Booster2_Cohort_Regression_PropensityScores))$conf.int
```

#### Hospitalization

```{r}
ggsurvplot(survfit(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster2, data = Q22022_Booster2_Cohort_Regression_PropensityScores),
           conf.int = TRUE,
           fun = "cumhaz")
```

```{r}
# For propensity for boosting
summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster2 + Propensity_ForBooster, data = Q22022_Booster2_Cohort_Regression_PropensityScores))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster2 + Propensity_ForBooster, data = Q22022_Booster2_Cohort_Regression_PropensityScores))$conf.int
```

```{r}
# For propensity for boosting
# Fully Adjusted
summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster2 + Propensity_ForBooster + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q22022_Booster2_Cohort_Regression_PropensityScores))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster2 + Propensity_ForBooster + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q22022_Booster2_Cohort_Regression_PropensityScores))$conf.int
```

```{r}
# Propensity for testing
summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster2 + Propensity_ForTesting, data = Q22022_Booster2_Cohort_Regression_PropensityScores))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster2 + Propensity_ForTesting, data = Q22022_Booster2_Cohort_Regression_PropensityScores))$conf.int
```

```{r}
# Propensity for testing
# Fully Adjusted
summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster2 + Propensity_ForTesting + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind, data = Q22022_Booster2_Cohort_Regression_PropensityScores))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster2 + Propensity_ForTesting + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind, data = Q22022_Booster2_Cohort_Regression_PropensityScores))$conf.int
```

```{r}
# For both propensity scores
summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster2 + Propensity_ForBooster + Propensity_ForTesting, data = Q22022_Booster2_Cohort_Regression_PropensityScores))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster2 + Propensity_ForBooster + Propensity_ForTesting, data = Q22022_Booster2_Cohort_Regression_PropensityScores))$conf.int
```

```{r}
# For both propensity scores
# Fully adjusted
summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster2 + Propensity_ForBooster + Propensity_ForTesting + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind, data = Q22022_Booster2_Cohort_Regression_PropensityScores))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster2 + Propensity_ForBooster + Propensity_ForTesting + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind, data = Q22022_Booster2_Cohort_Regression_PropensityScores))$conf.int
```


### IPW

#### Infection

```{r}
# For propensity for boosting
summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster2 , weights = IPW_ForBooster, data = Q22022_Booster2_Cohort_Regression_PropensityScores))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster2 , weights = IPW_ForBooster, data = Q22022_Booster2_Cohort_Regression_PropensityScores))$conf.int
```

```{r}
# For propensity for boosting
# Fully Adjusted
summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster2 + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, weights = IPW_ForBooster, data = Q22022_Booster2_Cohort_Regression_PropensityScores))
```

```{r}
# For propensity for testing
summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster2, weights = IPW_ForTesting, data = Q22022_Booster2_Cohort_Regression_PropensityScores))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster2, weights = IPW_ForTesting, data = Q22022_Booster2_Cohort_Regression_PropensityScores))$conf.int
```

```{r}
# For propensity for testing
# Fully Adjusted
summary(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster2 + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind, weights = IPW_ForTesting, data = Q22022_Booster2_Cohort_Regression_PropensityScores))
```

#### Hospitalization

```{r}
# For propensity for boosting
summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster2, weights = IPW_ForBooster, data = Q22022_Booster2_Cohort_Regression_PropensityScores))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster2, weights = IPW_ForBooster, data = Q22022_Booster2_Cohort_Regression_PropensityScores))$conf.int
```

```{r}
# For propensity for boosting
# Fully adjusted
summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster2 + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, weights = IPW_ForBooster, data = Q22022_Booster2_Cohort_Regression_PropensityScores))
```

```{r}
# For propensity for testing
summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster2, weights = IPW_ForTesting, data = Q22022_Booster2_Cohort_Regression_PropensityScores))
1 - summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster2, weights = IPW_ForTesting, data = Q22022_Booster2_Cohort_Regression_PropensityScores))$conf.int
```

```{r}
# For propensity for testing
# Fully adjusted
summary(coxph(Surv(time = SurvivalTime_Infection, event = Hosp_InPeriod) ~ Booster2 + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind, weights = IPW_ForTesting, data = Q22022_Booster2_Cohort_Regression_PropensityScores))
```

### Matched Model Extraction

```{r}
forest_matched_infection <- rbind.data.frame(
  # Non-Matched Reference
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster2, data = Q22022_Booster2_Cohort_Regression2)),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Infection_InPeriod) ~ Booster2 + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q22022_Booster2_Cohort_Regression2)),
  # For Boosting
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster2, data = Q22022_Booster2_Cohort_Regression_Exact_ForBoosting)),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster2 + strata(subclass), data = Q22022_Booster2_Cohort_Regression_Exact_ForBoosting)),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster2, data = Q22022_Booster2_Cohort_Regression_PropensityCaliper_ForBoosting)),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster2 + strata(subclass), 
              data = Q22022_Booster2_Cohort_Regression_PropensityCaliper_ForBoosting)),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster2 + Propensity_ForBooster, data = Q22022_Booster2_Cohort_Regression_PropensityScores)),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster2 + Propensity_ForBooster + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q22022_Booster2_Cohort_Regression_PropensityScores)),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster2 , weights = IPW_ForBooster, data = Q22022_Booster2_Cohort_Regression_PropensityScores)),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster2 + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, weights = IPW_ForBooster, data = Q22022_Booster2_Cohort_Regression_PropensityScores)),
  # For Testing
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster2, data = Q22022_Booster2_Cohort_Regression_Exact_ForTesting)),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster2 + strata(subclass), data = Q22022_Booster2_Cohort_Regression_Exact_ForTesting)),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster2, data = Q22022_Booster2_Cohort_Regression_PropensityCaliper_ForTesting)),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster2 + strata(subclass), data = Q22022_Booster2_Cohort_Regression_PropensityCaliper_ForTesting)),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster2 + Propensity_ForTesting, data = Q22022_Booster2_Cohort_Regression_PropensityScores)),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster2 + Propensity_ForTesting + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind, data = Q22022_Booster2_Cohort_Regression_PropensityScores)),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster2, weights = IPW_ForTesting, data = Q22022_Booster2_Cohort_Regression_PropensityScores)),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster2 + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind, weights = IPW_ForTesting, data = Q22022_Booster2_Cohort_Regression_PropensityScores)),
  # Both
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster2 + Propensity_ForBooster + Propensity_ForTesting, 
              data = Q22022_Booster2_Cohort_Regression_PropensityScores)),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Infection_InPeriod) ~ Booster2 + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, weights = IPW_ForBooster, data = Q22022_Booster2_Cohort_Regression_PropensityScores))
)
```

```{r}
forest_matched_severe <- rbind.data.frame(
  # Non-Matched Reference
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster2, data = Q22022_Booster2_Cohort_Regression2)),
  mod_extraction(coxph(Surv(SurvivalTime_Infection, Severe_InPeriod) ~ Booster2 + Age + Sex + BMI + RaceEthnicity4 + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q22022_Booster2_Cohort_Regression2)),
  # For Boosting
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster2, data = Q22022_Booster2_Cohort_Regression_Exact_ForBoosting)),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster2 + strata(subclass), data = Q22022_Booster2_Cohort_Regression_Exact_ForBoosting)),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster2, data = Q22022_Booster2_Cohort_Regression_PropensityCaliper_ForBoosting)),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster2 + strata(subclass), 
              data = Q22022_Booster2_Cohort_Regression_PropensityCaliper_ForBoosting)),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster2 + Propensity_ForBooster, data = Q22022_Booster2_Cohort_Regression_PropensityScores)),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster2 + Propensity_ForBooster + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, data = Q22022_Booster2_Cohort_Regression_PropensityScores)),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster2 , weights = IPW_ForBooster, data = Q22022_Booster2_Cohort_Regression_PropensityScores)),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster2 + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, weights = IPW_ForBooster, data = Q22022_Booster2_Cohort_Regression_PropensityScores)),
  # For Testing
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster2, data = Q22022_Booster2_Cohort_Regression_Exact_ForTesting)),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster2 + strata(subclass), data = Q22022_Booster2_Cohort_Regression_Exact_ForTesting)),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster2, data = Q22022_Booster2_Cohort_Regression_PropensityCaliper_ForTesting)),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster2 + strata(subclass), data = Q22022_Booster2_Cohort_Regression_PropensityCaliper_ForTesting)),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster2 + Propensity_ForTesting, data = Q22022_Booster2_Cohort_Regression_PropensityScores)),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster2 + Propensity_ForTesting + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind, data = Q22022_Booster2_Cohort_Regression_PropensityScores)),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster2, weights = IPW_ForTesting, data = Q22022_Booster2_Cohort_Regression_PropensityScores)),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster2 + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind, weights = IPW_ForTesting, data = Q22022_Booster2_Cohort_Regression_PropensityScores)),
  # Both
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster2 + Propensity_ForBooster + Propensity_ForTesting, 
              data = Q22022_Booster2_Cohort_Regression_PropensityScores)),
  mod_extraction(coxph(Surv(time = SurvivalTime_Infection, event = Severe_InPeriod) ~ Booster2 + Age + Sex + RaceEthnicity4 + BMI + disadvantage2_13_17_qrtl + popden13_17_qrtl + HCW + index + PrimaryCareMM_Ind + negativeTests_Cat, weights = IPW_ForBooster, data = Q22022_Booster2_Cohort_Regression_PropensityScores))
)
```